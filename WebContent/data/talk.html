<table id="data-talk-table" class="easyui-datagrid" data-options="fit:true,rownumbers:true,pagination:true,pageSize:30,pageList:[30,60,90],toolbar:'#data-talk-table-toolbar'">
	<thead>
		<tr>
			<th data-options="field:'checkbox',checkbox:true"></th>
			<th data-options="field:'id'" style="width:60px">编号</th>
			<th data-options="field:'title'" style="width:240px">宣讲会标题</th>
			<th data-options="field:'data_src'" style="width:80px">数据源</th>
			<th data-options="field:'data_key'" style="width:220px">唯一标识</th>
			<th data-options="field:'action',formatter:dataTalkTableActionFormatter" style="width:180px">操作</th>
		</tr>
	</thead>
</table>
<div id="data-talk-table-toolbar" style="padding: 2px 5px;">
	数据源：<input id="data-talk-table-source" class="easyui-combobox" data-options="valueField:'value',textField:'text'" style="width:120px" />
	<input id="data-talk-table-search" class="easyui-searchbox" data-options="prompt:'宣讲会标题'" style="width:200px" />
	<a id="data-talk-table-upload" class="easyui-linkbutton">上传</a>
</div>
<div id="data-talk-upload-window" class="easyui-window" data-options="title:'上传',modal:true,closed:true,footer:'#data-talk-upload-footer'" style="width:320px;height:400px">
    <ul id="data-talk-upload-tree" class="easyui-tree" data-options="checkbox:true,url:'data/talk/categories'" style="width:100%;height:100%"></ul>
</div>
<div id="data-talk-upload-footer" style="padding:5px;">
	<a id="data-talk-upload-confirm" class="easyui-linkbutton" style="width:80px">确定</a>
	<a id="data-talk-upload-cancel" class="easyui-linkbutton" style="width:80px">取消</a>
</div>
<script type="text/javascript">
	function dataTalkTableActionFormatter(value, row) {
		return '<a class="data-talk-table-look" data-talk="' + row.id + '" style="cursor:pointer;color:blue">查看</a>';
	}

	$.render(function() {
		var $dataTalkTable = $('#data-talk-table'), $dataTalkTableSource = $('#data-talk-table-source'), $dataTalkTableSearch = $('#data-talk-table-search');
		var $dataTalkUploadWindow = $('#data-talk-upload-window'), $dataTalkUploadTree = $('#data-talk-upload-tree');
		
		$('#data-talk-table-upload').click(function() {
			$dataTalkUploadWindow.window('open');
		});
		
		$dataTalkTableSource.combobox({
			url: 'data/talk/sources',
			onSelect: function(record) {
				$dataTalkTable.datagrid('load', {
					source: record.value,
					name: $dataTalkTableSearch.val()
				});
			}
		});
		
		$dataTalkTableSearch.searchbox({
			searcher: function(value) {
				$dataTalkTable.datagrid('load', {
					source: $dataTalkTableSource.combobox('getValue'),
					name: value
				});
			}
		});
		
		$dataTalkTable.datagrid({
			url:'data/talk',
			method:'get',
			onLoadSuccess: function() {
				$('.data-talk-table-look').click(function() {
					console.log('look...');
				});
			}
		});
		
		$('#data-talk-upload-confirm').click(function() {
			var rows = $dataTalkTable.datagrid('getChecked'), ids = [];
			for (var i = 0; i < rows.length; i ++) {
				if (rows[i].id)
					ids.push(rows[i].id);
			}
			var nodes = $dataTalkUploadTree.tree('getChecked'), codes = [];
			for (var i = 0; i < nodes.length; i ++) {
				if (nodes[i].code)
					codes.push(nodes[i].code);
			}
			$.post('data/talk/upload', {
				ids: ids,
				codes: codes
			}, function(resp) {
				if (resp.success) {
					$.messager.show({title: '提示', msg: '启动成功！', timeout: 1000, showType: 'slide'});
					$dataTalkUploadWindow.window('close');
				} else {
					if (!resp.finished) {
						$.messager.show({title: '提示', msg: '上传中...', timeout: 1000, showType: 'slide'});
					} else {
						$.messager.show({title: '提示', msg: '启动失败！', timeout: 1000, showType: 'slide'});
					}
				}
			}, 'json')
		});
		$('#data-talk-upload-cancel').click(function() {
			$dataTalkUploadWindow.window('close');
		});
	});
</script>