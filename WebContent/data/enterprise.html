<table id="data-enterprise-table" class="easyui-datagrid" data-options="fit:true,rownumbers:true,pagination:true,pageSize:30,pageList:[30,60,90],toolbar:'#data-enterprise-table-toolbar'">
	<thead>
		<tr>
			<th data-options="field:'checkbox',checkbox:true"></th>
			<th data-options="field:'id'" style="width:60px">编号</th>
			<th data-options="field:'name'" style="width:240px">企业名称</th>
			<th data-options="field:'data_src'" style="width:80px">数据源</th>
			<th data-options="field:'data_key'" style="width:220px">唯一标识</th>
			<th data-options="field:'action',formatter:dataEnterpriseTableActionFormatter" style="width:180px">操作</th>
		</tr>
	</thead>
</table>
<div id="data-enterprise-table-toolbar" style="padding: 2px 5px;">
	数据源：<input id="data-enterprise-table-source" class="easyui-combobox" data-options="valueField:'value',textField:'text'" style="width:120px" />
	<input id="data-enterprise-table-search" class="easyui-searchbox" data-options="prompt:'企业名称'" style="width:200px" />
	<a id="data-enterprise-table-upload" class="easyui-linkbutton">上传</a>
	<a id="data-enterprise-table-add" class="easyui-linkbutton">新增</a>
</div>
<div id="data-enterprise-upload-window" class="easyui-window" data-options="title:'上传',modal:true,closed:true,footer:'#data-enterprise-upload-footer'" style="width:320px;height:400px">
    <ul id="data-enterprise-upload-tree" class="easyui-tree" data-options="checkbox:true,url:'data/enterprise/categories'" style="width:100%;height:100%"></ul>
</div>
<div id="data-enterprise-upload-footer" style="padding:5px;">
	<a id="data-enterprise-upload-confirm" class="easyui-linkbutton" style="width:80px">确定</a>
	<a id="data-enterprise-upload-cancel" class="easyui-linkbutton" style="width:80px">取消</a>
</div>
<div id="data-enterprise-update-window" class="easyui-window " style="" data-options="maximizable:false,resizable:false,title:'修改',modal:true,closed:true,footer:'#data-enterprise-update-footer'" data-options="iconCls:'icon-save',modal:true;">
 
<div class="easyui-panel"  style="width:805px;height:600px;border:none;">
		<div class="easyui-layout" data-options="fit:true">
			 <div data-options="region:'west',iconCls:'icon-reload'" style="width:390px;height:600px;border:none;">
			 	<form id="data-enterprise-update-form" method="post">
 			<input style="display:none" type="text" id = "id" name="id" value=""></input>
 	   <table style="margin:10px">
                <tr>
                    <td style="width:130px">企业名称:</td>
                    <td><input class="easyui-textbox" style="width:250px" type="text"  name="name" data-options="required:true"></input></td>
                </tr>
                <tr>
                    <td>账号:</td>
                    <td><input class="easyui-textbox" style="width:250px" type="text" name="account" id="account" data-options="required:true"></input></td>
                </tr>
                
                <tr>
                    <td>行业:</td>
                    <td>
                    <input class="" style="width:250px;display:none;" type="text" id='ent_category' name="category" data-options="required:true"></input>
                    <input class="easyui-combobox" name="category_code" id="ent_category_code" data-options="valueField:'value',textField:'text',url:'json/industry.json',
                    onHidePanel:function(){$('#ent_category').val( $('#ent_category_code').textbox('getText'));}" /> </td>
                </tr>
                <tr>
                    <td>性质:</td>
                    <td><input class="" style="width:250px;display:none;" type="text" id='ent_nature' name="nature" data-options="required:true"></input>
                   <input class="easyui-combobox" name="nature_code" id="ent_nature_code" data-options="valueField:'value',textField:'text',url:'json/nature.json',
                    onHidePanel:function(){$('#ent_nature').val( $('#ent_nature_code').textbox('getText'));}" /> </td>
				
                </tr>
                <tr>
                    <td>规模:</td>
                    <td><input class="" style="width:250px;display:none;" type="text" id='ent_scale' name="scale" data-options="required:true"></input>
                    <input class="easyui-combobox" name="scale_code" id="ent_scale_code" data-options="valueField:'value',textField:'text',url:'json/scale.json',
                    onHidePanel:function(){$('#ent_scale').val( $('#ent_scale_code').textbox('getText'));}" /> </td>
					
                </tr>
                 <tr>
                    <td>标签:</td>
                    <td>
                        <input class="easyui-textbox" style="width:250px" type="text" name="tag" id="tag" ></input>
                    </td>
                </tr>
                 <tr>
                    <td>简介:</td>
                    <td>
                        <input class="easyui-textbox" type="text"  name="introduction" id ="introduction" data-options="multiline:true,required:true" style="width:250px; height:80px"></input>
                    </td>
                </tr>
                  <tr>
                    <td>区域:</td>
                    <td>
                   <input id="ent_area_code" name="area_code" class="easyui-combotree" style="width:200px;"   
        data-options="url:'json/area.json',required:true"></input> 
					
                </tr>
                  <tr>
                    <td>地址:</td>
                    <td>
                        <input class="easyui-textbox" style="width:250px" type="text" name="address" id="ent_address" data-options=""></input>
                    </td>
                </tr>
                  <tr>
                    <td>坐标点:</td>
                    <td>
                    	<input style="width:122px;" class="easyui-textbox" type="text" id = "ent_lbs_lon" name="lbs_lon" value=""data-options="readonly:true"></input>
                    	<input style="width:122px;" class="easyui-textbox"  type="text" id = "ent_lbs_lat" name="lbs_lat" value="" data-options="readonly:true"></input>
                    </td>
                </tr>
                <tr>
                    <td>地图:</td>
                    <td>
                    	<div id ="entMap" style="width:250px;height:250px"></div>
                    </td>
                </tr>
                  <tr>
                    <td>组织机构代码:</td>
                    <td>
                        <input class="easyui-textbox" style="width:250px" type="text" name="orgains" id="orgains" data-options=""></input>
                    </td>
                </tr>
                  <tr>
                    <td>工商营业执照编号:</td>
                    <td>
                        <input class="easyui-textbox" style="width:250px" type="text" name="license" id="license" data-options=""></input>
                    </td>
                </tr>
                <tr>
                    <td>联系人:</td>
                    <td>
                        <input class="easyui-textbox" style="width:250px" type="text" name="contacter" id="contacter" data-options=""></input>
                    </td>
                </tr>
                <tr>
                    <td>是否公开联系方式:</td>
                    <td>
                        <input class="easyui-textbox" style="width:250px" type="text" name="public_contact" id="public_contact" data-options=""></input>
                    </td>
                </tr>
                <tr>
                    <td>电话:</td>
                    <td>
                        <input class="easyui-textbox" style="width:250px" type="text" name="phone" id="phone" data-options=""></input>
                    </td>
                </tr>
                <tr>
                    <td>传真:</td>
                    <td>
                        <input class="easyui-textbox" style="width:250px" type="text" name="fax" id="fax" data-options=""></input>
                    </td>
                </tr>
                <tr>
                    <td>手机:</td>
                    <td>
                        <input class="easyui-textbox" style="width:250px" type="text" name="mobile" id="mobile" data-options=""></input>
                    </td>
                </tr>
                <tr>
                    <td>邮箱:</td>
                    <td>
                        <input class="easyui-textbox" style="width:250px" type="text" name="email" id="email" data-options=""></input>
                    </td>
                </tr>
                <tr>
                    <td>QQ号码:</td>
                    <td>
                        <input class="easyui-textbox" style="width:250px" type="text" name="qq" id="qq" data-options=""></input>
                    </td>
                </tr>
                <tr>
                    <td>数据源:</td>
                    <td>
                        <input class="easyui-textbox" style="width:250px" type="text" name="data_src" id="data_src" data-options=""></input>
                    </td>
                </tr>
                <tr>
                    <td>唯一标识:</td>
                    <td>
                        <input class="easyui-textbox" style="width:250px" type="text" name="data_key" id="data_key" data-options=""></input>
                    </td>
                </tr>
                <tr>
                    <td>更新时间:</td>
                    <td>
                    <input class="easyui-datetimebox" name="update_date"     
        data-options="required:true,showSeconds:false" value="" style="width:150px"/>  
                        
                    </td>
                </tr>
                  <tr>
                    <td>创建时间:</td>
                    <td>
                     <input class="easyui-datetimebox" name="create_date"     
        data-options="required:true,showSeconds:false" value="" style="width:150px"/> 
                    </td>
                </tr>
                   <tr>
                    <td>角色id:</td>
                    <td>
                        <input class="easyui-textbox" style="width:250px" type="text" name="role" id="role" data-options=""></input>
                    </td>
                </tr>
                   <tr>
                    <td>是否认证:</td>
                    <td>
                        <input class="easyui-textbox" style="width:250px" type="text" name="legalize" id="legalize" data-options=""></input>
                    </td>
                </tr>
                
            </table>
</form>
			 </div>   
    		<div data-options="region:'center',width:'390px'" class="easyui-layout" style="height:600px;width:390px;border:none;">
    		
	    		<div data-options="region:'north',iconCls:'icon-reload',width:'390px'" style="height:150px;width:390px;border:none;">
	    			<table class="easyui-datagrid" id ="data-post-table">   
					    <thead >   
					        <tr>   
					            <th data-options="field:'name'"  style="width:100px">岗位名称</th>   
					            <th data-options="field:'address'"  style="width:180px">工作地点</th>   
					            <th data-options="field:'headcount'"  style="width:40px">人数</th>
					            <th data-options="field:'nature'"  style="width:40px">性质</th>   
					            <th data-options="field:'education'"  style="width:40px">学历</th>   
					        </tr>   
					    </thead>   
					</table>  
	    		</div>   
	    		<div data-options="region:'center'" style="width:390px;border:none;">
	    			<form id="data-post-form" method="post">   
	    			<input class="" style="width:250px;display:none;" type="text"  name="id" ></input>
					     <table style="margin:10px">
                <tr>
                    <td style="width:130px">岗位名称:</td>
                    <td><input class="easyui-textbox" style="width:250px" type="text"  name="name" data-options="required:true"></input></td>
                </tr>
                <tr>
                    <td>岗位类别:</td>
                    <td><input id="post_category_code" name="category_code" class="easyui-combotree" style="width:200px;"   
        data-options="url:'json/category.json',required:true"></input></td>
                </tr>
                <tr>
                    <td>求职类型:</td>
                   <td><input class="" style="width:250px;display:none;" type="text" id='post_nature' name="nature" data-options="required:true"></input>
                   <input class="easyui-combobox" name="nature_code" id="post_nature_code" data-options="valueField:'value',textField:'text',url:'json/post_nature.json',
                    onHidePanel:function(){$('#post_nature').val( $('#post_nature_code').textbox('getText'));}" /> </td>
                </tr>
               
                 <tr>
                    <td>招聘人数:</td>
                    <td><input class="easyui-textbox" style="width:250px" type="text" name="headcount" id="post_headcount" data-options="required:true"></input></td>
                </tr>
                <tr>
                    <td>年龄段:</td>
                    <td><input class="easyui-textbox" style="width:250px" type="text" name="age" id="post_age" data-options=""></input></td>
                </tr>
                
                <tr>
                    <td>性别:</td>
                    <td><input class="easyui-combobox" style="" type="text" name="gender" id="post_gender" data-options="data:[{'id':'1','text':'男'},{'id':'0','text':'女'},{'id':'-1','text':'不限'}]"></input></td>
                </tr>
                <tr>
                    <td>薪资:</td>
                    <td><input class="easyui-textbox" style="width:250px" type="text" name="salary" id="post_salary" data-options="required:true"></input></td>
                </tr>
                <tr>
                    <td>工作经验:</td>
                    <td><input class="" style="width:250px;display:none;" type="text" id='post_experience' name="experience_code" data-options="required:true"></input>
                   <input class="easyui-combobox" name="experience_code" id="post_experience_code" data-options="valueField:'value',textField:'text',url:'json/experience.json',
                    onHidePanel:function(){$('#post_experience').val( $('#post_experience_code').textbox('getText'));}" /> </td>
                </tr>
                <tr>
                    <td>最低学历:</td>
                    <td><input class="" style="width:250px;display:none;" type="text" id='post_education' name="education_code" data-options="required:true"></input>
                   <input class="easyui-combobox" name="education_code" id="post_education_code" data-options="valueField:'value',textField:'text',url:'json/education.json',
                    onHidePanel:function(){$('#post_education').val( $('#post_education_code').textbox('getText'));}" /> </td>
                </tr>
                 <tr>
                    <td>标签:</td>
                    <td><input class="easyui-textbox" style="width:250px" type="text" name="tag" id="post_tag" data-options="required:true"></input></td>
                </tr>
                 <tr>
                    <td>岗位介绍:</td>
                    <td><input class="easyui-textbox" style="width:250px" type="text" name="introduction" id="post_introduction" data-options="required:true"></input></td>
                </tr>
                 <tr>
                    <td>区域:</td>
                    <td><input id="post_area_code" name="area_code" class="easyui-combotree" style="width:200px;"   
        data-options="url:'json/area.json',required:true"></input> </td>
                </tr>
                 <tr>
                    <td>工作地点:</td>
                    <td><input class="easyui-textbox" style="width:250px" type="text" name="address" id="post_address" data-options="required:true"></input></td>
                </tr>
                 <tr>
                    <td>坐标:</td>
                    <td><input style="width:122px;" class="easyui-textbox" type="text" id = "post_lbs_lon" name="lbs_lon" value=""data-options="readonly:true"></input>
                    	<input style="width:122px;" class="easyui-textbox"  type="text" id = "post_lbs_lat" name="lbs_lat" value="" data-options="readonly:true"></input></td>
                </tr>
                 <tr>
                    <td>地图:</td>
                    <td><div id ="postMap" style="width:250px;height:250px"></div></td>
                </tr>
                 <tr>
                    <td>数据源:</td>
                    <td><input class="easyui-textbox" style="width:250px" type="text" name="data_src" id="post_data_src" data-options="required:true"></input></td>
                </tr>
                 <tr>
                    <td>唯一标识:</td>
                    <td><input class="easyui-textbox" style="width:250px" type="text" name="data_key" id="post_data_key" data-options="required:true"></input></td>
                </tr>
                <tr>
                    <td>企业唯一标识:</td>
                    <td><input class="easyui-textbox" style="width:250px" type="text" name="data_ent_key" id="post_data_ent_key" data-options="required:true"></input></td>
                </tr>
                <tr>
                    <td>更新时间:</td>
                    <td><input class="easyui-datetimebox" name="update_date"     
        data-options="required:true,showSeconds:false" value="" style="width:150px"/> </td>
                </tr>
                <tr>
                    <td>创建时间:</td>
                    <td><input class="easyui-datetimebox" name="create_date"     
        data-options="required:true,showSeconds:false" value="" style="width:150px"/> </td>
                </tr>
                </table>
					</form>  
	    		</div>
		</div>
	</div>

<div id="data-enterprise-update-footer" style="padding:5px;">
	<a id="data-enterprise-update-confirm" class="easyui-linkbutton" onclick="submitFrom()"  style="width:80px">确定</a>
	<a id="data-enterprise-update-cancel" class="easyui-linkbutton" onclick="closeWindow()" style="width:80px">取消</a>
	<a id="data-enterprise-update-cancel" class="easyui-linkbutton" onclick="closeWindow()" style="width:80px;float:right;">查看岗位</a>
</div>

</div>
</div>
<script type="text/javascript">
	function dataEnterpriseTableActionFormatter(value, row) {
		return '<a class="data-enterprise-table-look" onclick="openFromWindow('+row.id+',\''+row.data_key+'\')" data-enterprise="'  + row.id + '" style="cursor:pointer;color:blue">查看</a>'+
		' <a class="data-talk-enterprise-delete" onclick="deleteData('+ row.id +')"  data-enterprise="' + row.id + '" style="cursor:pointer;color:blue">删除</a>';
	}

	$.render(function() {
		var $dataEnterpriseTable = $('#data-enterprise-table'), $dataEnterpriseTableSource = $('#data-enterprise-table-source'), $dataEnterpriseTableSearch = $('#data-enterprise-table-search');
		var $dataEnterpriseUploadWindow = $('#data-enterprise-upload-window'), $dataEnterpriseUploadTree = $('#data-enterprise-upload-tree');
		var $dataEnterpriseUpdateWindow=$('#data-enterprise-update-window');
		var $entaddress=$('#ent_address');
		var $postaddress=$('#post_address');
		var $dataPostTable=$('#data-post-table');
		
		$entaddress.textbox({
			onChange: function(addr){
				BaiduMap("entMap", addr)
			}
		});
		$postaddress.textbox({
			onChange: function(addr){
				BaiduMap("postMap", addr)
			}
		});
		
		$('#data-enterprise-table-upload').click(function() {
			$dataEnterpriseUploadWindow.window('open');
		});
		$('#data-enterprise-table-add').click(function() {
			$dataEnterpriseUpdateWindow.window({title:"新增"});
			$('#data-enterprise-update-form').form("clear");
			$dataEnterpriseUpdateWindow.window("open");
			
		});
		
		$dataEnterpriseTableSource.combobox({
			url: 'data/enterprise/sources',
			onSelect: function(record) {
				$dataEnterpriseTable.datagrid('load', {
					source: record.value,
					name: $dataEnterpriseTableSearch.val()
				});
			}
		});
	
		$dataEnterpriseTableSearch.searchbox({
			searcher: function(value) {
				$dataEnterpriseTable.datagrid('load', {
					source: $dataEnterpriseTableSource.combobox('getValue'),
					name: value
				});
			}
		});
		//不能选择子节点
		$('#ent_area_code').combotree({
			onBeforeSelect: function(node) {
				if (!$(this).tree('isLeaf', node.target)) {
					return false;
				}
			},
			onClick: function(node) {
				if (!$(this).tree('isLeaf', node.target)) {
					$('#ent_area_code').combo('showPanel');
				}
			}
		});
		//不能选择子节点
		$('#post_area_code').combotree({
			onBeforeSelect: function(node) {
				if (!$(this).tree('isLeaf', node.target)) {
					return false;
				}
			},
			onClick: function(node) {
				if (!$(this).tree('isLeaf', node.target)) {
					$('#post_area_code').combo('showPanel');
				}
			}
		});
		
		//不能选择子节点
		$('#post_category_code').combotree({
			onBeforeSelect: function(node) {
				if (!$(this).tree('isLeaf', node.target)) {
					return false;
				}
			},
			onClick: function(node) {
				if (!$(this).tree('isLeaf', node.target)) {
					$('#post_category_code').combo('showPanel');
				}
			}
		});
		
		$dataEnterpriseTable.datagrid({
			url:'data/enterprise',
			method:'get',
			onLoadSuccess: function() {
				$('.data-enterprise-table-look').click(function() {
					console.log('look...');
				})
			}
		});
		$dataPostTable.datagrid ({
			striped:true,
			singleSelect:true,
			onClickRow:function(rowIndex,rowData){
				$('#data-post-form').form("clear");
				$('#data-post-form').form('load','data/entpost/getEntpost?id='+rowData.id);
				console.log($('#post_address').textbox('getValue'))
				BaiduMap("postMap","");
			}
		})
		
		$('#data-enterprise-upload-confirm').click(function() {
			var rows = $dataEnterpriseTable.datagrid('getChecked'), ids = [];
			for (var i = 0; i < rows.length; i ++) {
				if (rows[i].id)
					ids.push(rows[i].id);
			}
			var nodes = $dataEnterpriseUploadTree.tree('getChecked'), codes = [];
			for (var i = 0; i < nodes.length; i ++) {
				if (nodes[i].code)
					codes.push(nodes[i].code);
			}
			$.post('data/enterprise/upload', {
				ids: ids,
				codes: codes
			}, function(resp) {
				if (resp.success) {
					$.messager.show({title: '提示', msg: '启动成功！', timeout: 1000, showType: 'slide'});
					$dataEnterpriseUploadWindow.window('close');
				} else {
					if (!resp.finished) {
						$.messager.show({title: '提示', msg: '上传中...', timeout: 1000, showType: 'slide'});
					} else {
						$.messager.show({title: '提示', msg: '启动失败！', timeout: 1000, showType: 'slide'});
					}
				}
			}, 'json')
		});
		$('#data-enterprise-upload-cancel').click(function() {
			$dataEnterpriseUploadWindow.window('close');
		});
		
		
	});
	//点击修改
	function openFromWindow(id,data_key){
		$('#data-enterprise-update-window').window({title:"修改"});
		$('#data-enterprise-update-window').window("open");
		$('#data-enterprise-update-form').form("clear");
		$('#data-post-form').form("clear");
		$('#data-enterprise-update-form').form('load','data/enterprise/getEnt?id='+id);
		$('#data-post-table').datagrid({
			url:'data/entpost/list?data_key='+data_key,
			method:'get'
		})
	}
	
	function BaiduMap(id,addr)
	{
		if (addr=="") addr="北京";
		var map = new BMap.Map(id);  
		map.centerAndZoom(addr,12);    
		map.setDefaultCursor("crosshair");
		var $lat=null;
		var $lon=null;
		var $address=null;
		if(id=="entMap"){
			$lat=$('#ent_lbs_lat');
			$lon=$('#ent_lbs_lon');
			$address=$('#ent_address');
		}else{
			$lat=$('#post_lbs_lat');
			$lon=$('#post_lbs_lon');
			$address=$('#post_address');
		}
		
		map.clearOverlays();  
        var new_point = new BMap.Point($lon.textbox('getValue'),$lat.textbox('getValue'));
        // 创建标注  
        var marker = new BMap.Marker(new_point);  
        // 将标注添加到地图中  
        map.addOverlay(marker);  
        map.panTo(new_point);  
        
		//单击获取点击的经纬度
		map.addEventListener("click",function(e){
			$lat.textbox("setValue",e.point.lat);
			$lon.textbox("setValue",e.point.lng);
	        map.clearOverlays();  
	        var new_point = new BMap.Point(e.point.lng,e.point.lat);
	        // 创建标注  
	        var marker = new BMap.Marker(new_point);  
	        // 将标注添加到地图中  
	        map.addOverlay(marker);  
	        map.panTo(new_point);  
	        var geoc = new BMap.Geocoder(); 
	        var pt = e.point;
			geoc.getLocation(pt, function(rs){
				var addComp = rs.addressComponents;
				//alert(addComp.province + ", " + addComp.city + ", " + addComp.district + ", " + addComp.street + ", " + addComp.streetNumber);
				$address.textbox("setValue",addComp.province+addComp.city+addComp.district+addComp.street+addComp.streetNumber);
			});        
	        
		});
	}
	
	//提交表单
	function submitFrom(){
		var $dataEnterpriseUpdateWindow = $('#data-enterprise-upload-window');
		//ent
		$('#data-enterprise-update-form').form('submit', {
			url: 'data/enterprise/saveEnt',
			onSubmit: function(){
				var isValid = $(this).form('validate');
				if (!isValid){
					$.messager.progress('close');
				}
				return isValid;
			},
			success: function(){
				$('#data-enterprise-table').datagrid('reload'); 
				//$('#data-enterprise-update-window').window('close');
				$.messager.show({title: '提示', msg: '执行成功！', timeout: 1000, showType: 'slide'});
			}
		});
		
		//post
		$('#data-post-form').form('submit', {
			url: 'data/entpost/saveEntpost',
			onSubmit: function(){
				var isValid = $(this).form('validate');
				if (!isValid){
					$.messager.progress('close');
				}
				return isValid;
			},
			success: function(){
				$('#data-post-table').datagrid('reload'); 
				//$('#data-enterprise-update-window').window('close');
				$.messager.show({title: '提示', msg: '执行成功！', timeout: 1000, showType: 'slide'});
			}
		});
		
	
		
	}
	//关闭form窗口
	function closeWindow(){
		$('#data-enterprise-update-window').window('close');
	}
	//删除数据
	function deleteData(id){
		$.post('data/enterprise/deleteEnt', {
			id: id
		}, function(resp) {
			if(resp.success){
				$('#data-enterprise-table').datagrid('reload'); 
				$.messager.show({title: '提示', msg: '删除成功！', timeout: 1000, showType: 'slide'});
			}else{
				$.messager.show({title: '提示', msg: '删除失败！', timeout: 1000, showType: 'slide'});
			}
		}, 'json'); 
	}
	
</script>
