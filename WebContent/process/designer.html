<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>流程设计</title>
<script type="text/javascript" src="${ctx}/common/jquery.min.js"></script>
<script type="text/javascript" src="${ctx}/common/jquery.custom.js"></script>
<link rel="stylesheet" type="text/css" href="${ctx}/common/easyui/themes/default/easyui.css">
<link rel="stylesheet" type="text/css" href="${ctx}/common/easyui/themes/icon.css">
<script type="text/javascript" src="${ctx}/common/easyui/jquery.easyui.min.js"></script>
<script type="text/javascript" src="${ctx}/common/easyui/locale/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="${ctx}/common/raphael-min.js"></script>
<script type="text/javascript" src="${ctx}/common/snaker.designer.js"></script>
</head>
<body>
<div class="easyui-layout" data-options="fit:true">
	<div id="precess-designer-toolbox" data-options="region:'west',split:true,title:'工具'" style="width:110px;text-align:center">
		<br /><a id="process-designer-toolbox-save" class="easyui-linkbutton">保存</a><br />
		<br /><input id="precess-designer-toolbox-moveable" class="easyui-switchbutton" data-options="onText:'移动',offText:'连线'" style="width:80%;margin:10px;padding:10px;" checked><br />
		<br /><a id="process-designer-toolbox-ele-delete" class="easyui-linkbutton">删除</a><br /><br />
		<div class="easyui-accordion" data-options="border:false,multiple:true">
			<div data-options="title:'通用',collapsed:false" style="text-align:center;padding-left:10px;padding-top:10px">
				<p class="precess-designer-toolbox-citem" data-mtype="begin" style="width:80px;height:20px;line-height:20px;background:#fafafa">开始</p>
				<p class="precess-designer-toolbox-citem" data-mtype="end" style="width:80px;height:20px;line-height:20px;background:#fafafa">结束</p>
				<p class="precess-designer-toolbox-citem" data-mtype="addFields" style="width:80px;height:20px;line-height:20px;background:#fafafa">添加属性</p>
			</div>
			<div data-options="title:'输入',collapsed:false" style="text-align:center;padding-left:10px;padding-top:10px">
				<p class="precess-designer-toolbox-citem" data-mtype="tableinput" style="width:80px;height:20px;line-height:20px;background:#fafafa">表格输入</p>
				<p class="precess-designer-toolbox-citem" data-mtype="webinput" style="width:80px;height:20px;line-height:20px;background:#fafafa">页面输入</p>
				<p class="precess-designer-toolbox-citem" data-mtype="excelinput" style="width:80px;height:20px;line-height:20px;background:#fafafa">Excel输入</p>
				<p class="precess-designer-toolbox-citem" data-mtype="hbinput" style="width:80px;height:20px;line-height:20px;background:#fafafa">湖北输入</p>
			</div>
			<div data-options="title:'映射',collapsed:false" style="text-align:center;padding-left:10px;padding-top:10px">
				<p class="precess-designer-toolbox-citem" data-mtype="tablemapper" style="width:80px;height:20px;line-height:20px;background:#fafafa">表格映射</p>
				<p class="precess-designer-toolbox-citem" data-mtype="excelmapper" style="width:80px;height:20px;line-height:20px;background:#fafafa">Excel映射</p>
			</div>
			<div data-options="title:'输出',collapsed:false" style="text-align:center;padding-left:10px;padding-top:10px">
				<p class="precess-designer-toolbox-citem" data-mtype="dbtableoutput" style="width:80px;height:20px;line-height:20px;background:#fafafa">表输出</p>
			</div>
			<div data-options="title:'上传',collapsed:false" style="text-align:center;padding-left:10px;padding-top:10px">
				<p class="precess-designer-toolbox-citem" data-mtype="dbprocoutput" style="width:80px;height:20px;line-height:20px;background:#fafafa">存储过程输出</p>
			</div>
		</div>
	</div>
	<div id="process-designer-tabs" class="easyui-tabs" data-options="region:'center'">
		<div id="process-designer-tabs-canvas" data-options="title:'画板'" style="position:absolute"></div>
		<div id="process-designer-tabs-content" data-options="title:'内容'">{}</div>
	</div>
	<div data-options="region:'east',split:true,title:'属性'" style="width:300px">
		<form id="process-designer-prop-form" style="height:50px">
			<br />
			名称：<input type="text" class="easyui-textbox" style="width:250px" name="name"></input>
		</form>
		<table id="process-designer-prop-box" class="easyui-propertygrid" data-options="columns:[[{field:'name',title:'名称'},{field:'value',title:'内容',width:100}]],fix:true"></table>
	</div>
</div>


<div id="module-tableinput-editor-data-headers" class="easyui-window" data-options="title:'头定义',modal:true,closed:true,footer:'#module-tableinput-editor-data-headers-footer'" style="width:600px;height:500px">
	<table id="module-tableinput-editor-data-headers-table" class="easyui-datagrid" data-options="border:false,fit:true,toolbar:'#module-tableinput-editor-data-headers-toolbar'">
		<thead>
			<tr>
				<th data-options="field:'name',width:100,editor:{type:'textbox'}">名称</th>
				<th data-options="field:'type',width:100,formatter:function(v,r){var options=this.editor.options;for(var i=0;i<options.data.length;i++){if(options.data[i][options.valueField]==v)return options.data[i][options.textField]}return ''},editor:{type:'combobox',options:{textField:'name',valueField:'value',data:[{name:'字符串',value:'string'},{name:'整形',value:'integer'},{name:'长整形',value:'long'},{name:'小数',value:'double'},{name:'日期',value:'date'}]}}">类型</th>
				<th data-options="field:'format',width:100,editor:{type:'textbox'}">格式</th>
			</tr>
		</thead>
	</table>
	<div id="module-tableinput-editor-data-headers-toolbar">
		<a id="module-tableinput-editor-data-headers-add" class="easyui-linkbutton">新增</a>
		<a id="module-tableinput-editor-data-headers-remove" class="easyui-linkbutton">删除</a>
	</div>
</div>
<div id="module-tableinput-editor-data-headers-footer" style="padding:5px;">
	<a id="module-tableinput-editor-data-headers-confirm" class="easyui-linkbutton" style="width:80px">确定</a>
	<a id="module-tableinput-editor-data-headers-cancel" class="easyui-linkbutton" style="width:80px">取消</a>
</div>


<div id="module-tableinput-editor-data-rows" class="easyui-window" data-options="title:'表数据',modal:true,closed:true,footer:'#module-tableinput-editor-data-rows-footer'" style="width:600px;height:500px">
	<table id="module-tableinput-editor-data-rows-table" class="easyui-datagrid" data-options="border:false,fit:true,toolbar:'#module-tableinput-editor-data-rows-toolbar'"></table>
	<div id="module-tableinput-editor-data-rows-toolbar">
		<a id="module-tableinput-editor-data-rows-add" class="easyui-linkbutton">新增</a>
		<a id="module-tableinput-editor-data-rows-remove" class="easyui-linkbutton">删除</a>
	</div>
</div>
<div id="module-tableinput-editor-data-rows-footer" style="padding:5px;">
	<a id="module-tableinput-editor-data-rows-confirm" class="easyui-linkbutton" style="width:80px">确定</a>
	<a id="module-tableinput-editor-data-rows-cancel" class="easyui-linkbutton" style="width:80px">取消</a>
</div>


<div id="module-tableinput-editor-data-mappers" class="easyui-window" data-options="title:'表映射',modal:true,closed:true,footer:'#module-tableinput-editor-data-mappers-footer'" style="width:600px;height:500px">
	<table id="module-tableinput-editor-data-mappers-table" class="easyui-datagrid" data-options="border:false,fit:true,toolbar:'#module-tableinput-editor-data-mappers-toolbar'">
		<thead>
			<tr>
				<th data-options="field:'from',width:100,editor:{type:'textbox'}">从</th>
				<th data-options="field:'to',width:100,editor:{type:'textbox'}">到</th>
			</tr>
		</thead>
	</table>
	<div id="module-tableinput-editor-data-mappers-toolbar">
		字段：<input id="module-tableinput-editor-data-mappers-name" class="easyui-combobox" data-options="valueField:'name',textField:'name'">
		<a id="module-tableinput-editor-data-mappers-add" class="easyui-linkbutton">新增</a>
	</div>
</div>
<div id="module-tableinput-editor-data-mappers-footer" style="padding:5px;">
	<a id="module-tableinput-editor-data-mappers-confirm" class="easyui-linkbutton" style="width:80px">确定</a>
	<a id="module-tableinput-editor-data-mappers-cancel" class="easyui-linkbutton" style="width:80px">取消</a>
</div>


<div id="module-tableinput-editor-data-paths" class="easyui-window" data-options="title:'头定义',modal:true,closed:true,footer:'#module-tableinput-editor-data-paths-footer'" style="width:1500px;height:700px">
	<table id="module-tableinput-editor-data-paths-table" class="easyui-datagrid" data-options="border:false,fit:true,toolbar:'#module-tableinput-editor-data-paths-toolbar'">
		<thead>
			<tr>
				<th data-options="field:'name',width:200,editor:{type:'textbox'}">名称</th>
				<th data-options="field:'xpath',width:550,editor:{type:'textbox'}">XPath</th>
				<th data-options="field:'regex',width:550,editor:{type:'textbox'},formatter:$.encodeHtml">Regex</th>
				<th data-options="field:'isAll',width:100,editor:{type:'textbox'}">isAll</th>
			</tr>
		</thead>
	</table>
	<div id="module-tableinput-editor-data-paths-toolbar">
		<a id="module-tableinput-editor-data-paths-add" class="easyui-linkbutton">新增</a>
	</div>
</div>
<div id="module-tableinput-editor-data-paths-footer" style="padding:5px;">
	<a id="module-tableinput-editor-data-paths-confirm" class="easyui-linkbutton" style="width:80px">确定</a>
	<a id="module-tableinput-editor-data-paths-cancel" class="easyui-linkbutton" style="width:80px">取消</a>
</div>


<div id="module-tableinput-editor-proc-fields" class="easyui-window" data-options="title:'字段映射',modal:true,closed:true,footer:'#module-tableinput-editor-proc-fields-footer'" style="width:600px;height:500px">
	<table id="module-tableinput-editor-proc-fields-table" class="easyui-datagrid" data-options="border:false,fit:true">
		<thead>
			<tr>
				<th data-options="field:'name',width:100">表字段</th>
				<th data-options="field:'from',width:100,editor:{type:'textbox'}">映射字段</th>
			</tr>
		</thead>
	</table>
</div>
<div id="module-tableinput-editor-proc-fields-footer" style="padding:5px;">
	<a id="module-tableinput-editor-proc-fields-confirm" class="easyui-linkbutton" style="width:80px">确定</a>
	<a id="module-tableinput-editor-proc-fields-cancel" class="easyui-linkbutton" style="width:80px">取消</a>
</div>


<div id="module-tableinput-editor-params" class="easyui-window" data-options="title:'参数定义',modal:true,closed:true,footer:'#module-tableinput-editor-params-footer'" style="width:600px;height:500px">
	<table id="module-tableinput-editor-params-table" class="easyui-datagrid" data-options="border:false,fit:true">
		<thead>
			<tr>
				<th data-options="field:'name'" style="width:20%">名称</th>
				<th data-options="field:'type',formatter:function(v){return {string:'字符串',integer:'数字',date:'日期',file:'文件'}[v]}" style="width:20%">类型</th>
				<th data-options="field:'editor',formatter:function(v,r){var options=this.editor.options;for(var i=0;i<options.data.length;i++){if(options.data[i][options.valueField]==v)return options.data[i][options.textField]}return ''},editor:{type:'combobox',options:{textField:'name',valueField:'value',data:[{name:'文本框',value:'textbox'},{name:'数字框',value:'numberspinner'},{name:'下拉框',value:'combobox'},{name:'日期框',value:'datebox'},{name:'文件框',value:'filebox'}]}}" style="width:20%">编辑器</th>
				<th data-options="field:'options',editor:'textbox'" style="width:40%">选项</th>
			</tr>
		</thead>
	</table>
</div>

<div id="module-addField-editor-data-headers" class="easyui-window" data-options="title:'添加属性',modal:true,closed:true,footer:'#module-tableinput-editor-params-footer'" style="width:600px;height:500px">
	<table id="module-addField-editor-data-headers-table" class="easyui-datagrid" data-options="border:false,fit:true,toolbar:'#module-addField-editor-data-headers-toolbar'">
		<thead>
			<tr>
				<th data-options="field:'name',width:100,editor:{type:'textbox'}">属性名称</th>
				<th data-options="field:'type',width:100,formatter:function(v,r){var options=this.editor.options;for(var i=0;i<options.data.length;i++){if(options.data[i][options.valueField]==v)return options.data[i][options.textField]}return ''},editor:{type:'combobox',options:{textField:'name',valueField:'value',data:[{name:'常量',value:'constant'},{name:'变量',value:'variable'},{name:'脚本',value:'script'},{name:'其他',value:'others'}]}}">类型</th>
				<th data-options="field:'datatype',width:100,formatter:function(v,r){var options=this.editor.options;for(var i=0;i<options.data.length;i++){if(options.data[i][options.valueField]==v)return options.data[i][options.textField]}return ''},editor:{type:'combobox',options:{textField:'name',valueField:'value',data:[{name:'字符串',value:'string'},{name:'整形',value:'integer'},{name:'长整形',value:'long'},{name:'小数',value:'double'},{name:'日期',value:'date'}]}}">数据类型</th>
				<th data-options="field:'value',width:100,editor:{type:'textbox'}">值</th>
			</tr>
		</thead>
	</table>
	<div id="module-addField-editor-data-headers-toolbar">
		<a id="module-addField-editor-data-headers-add" class="easyui-linkbutton">新增</a>
		<a id="module-addField-editor-data-headers-remove" class="easyui-linkbutton">删除</a>
	</div>
</div>


<div id="module-tableinput-editor-params-footer" style="padding:5px;">
	<a id="module-tableinput-editor-params-confirm" class="easyui-linkbutton" style="width:80px">确定</a>
	<a id="module-tableinput-editor-params-cancel" class="easyui-linkbutton" style="width:80px">取消</a>
</div>
<script type="text/javascript">
	$(function() {
		var editor = {};
		editor.dataHeaders = {
			$window: $('#module-tableinput-editor-data-headers'),
			$table: $('#module-tableinput-editor-data-headers-table'),
			$btnAdd: $('#module-tableinput-editor-data-headers-add'),
			$btnRemove: $('#module-tableinput-editor-data-headers-remove'),
			$btnConfirm: $('#module-tableinput-editor-data-headers-confirm'),
			$btnCancel: $('#module-tableinput-editor-data-headers-cancel'),
			endEditing: function() {
				var _this = editor.dataHeaders;
				if (_this.lastEditingIndex == null) return true;
				if (_this.$table.datagrid('validateRow', _this.lastEditingIndex)) {
					_this.$table.datagrid('endEdit', _this.lastEditingIndex);
					_this.lastEditingIndex = null;
					return true;
				}
				return false;
			},
			init: function(index, row) {
				var _this = editor.dataHeaders;
				if (!_this._initEvent) {
					_this.$table.datagrid({
						onClickCell: function(index, field) {
							if (index != _this.lastEditingIndex) {
								if (_this.endEditing()) {
									_this.$table.datagrid('selectRow', index).datagrid('beginEdit', index);
									var editor = _this.$table.datagrid('getEditor', {index: index, field: field});
					                if (editor){
					                    ($(editor.target).data('textbox') ? $(editor.target).textbox('textbox') : $(editor.target)).focus();
					                }
					                _this.lastEditingIndex = index;
								} else {
									_this.$table.datagrid('selectRow', _this.lastEditingIndex);
								}
							}
						}
					});
					_this.$btnAdd.click(function() {
						_this.$table.datagrid('appendRow',{name: '', type: 'string', format: ''});
					});
					_this.$btnConfirm.click(function() {
						if (_this.endEditing()) {
							row.value = _this.$table.datagrid('getRows');
							Designer.PropBox.updateValue(index, row, true);
							_this.$window.window('close', true);
						}
					});
					_this.$btnCancel.click(function() {
						_this.$window.window('close', true);
					});
					_this.$btnRemove.click(function() {
						_this.$table.datagrid('deleteRow', _this.lastEditingIndex);
					});
					_this._initEvent = true;
				}
			},
			setValue: function(value) {
				editor.dataHeaders.$table.datagrid('loadData', value);
			},
			show: function() {
				editor.dataHeaders.$window.window('open', true);
			}
		}
		
		editor.dataRows = {
			$window: $('#module-tableinput-editor-data-rows'),
			$table: $('#module-tableinput-editor-data-rows-table'),
			$btnAdd: $('#module-tableinput-editor-data-rows-add'),
			$btnRemove: $('#module-tableinput-editor-data-rows-remove'),
			$btnConfirm: $('#module-tableinput-editor-data-rows-confirm'),
			$btnCancel: $('#module-tableinput-editor-data-rows-cancel'),
			endEditing: function() {
				var _this = editor.dataRows;
				if (_this.lastEditingIndex == null) return true;
				if (_this.$table.datagrid('validateRow', _this.lastEditingIndex)) {
					_this.$table.datagrid('endEdit', _this.lastEditingIndex);
					_this.lastEditingIndex = null;
					return true;
				}
				return false;
			},
			_editor: {string: 'textbox', integer: 'numberspinner', long: 'numberspinner', double: 'numberspinner', date: 'datetimebox'},
			init: function(index, row) {
				var _this = editor.dataRows;
				var headers = Designer.PropBox.current.data('dataHeaders');
				_this.$table.datagrid({
					columns: [headers.map(function(row) {return {title: row.name, field: row.name, width: 100, editor: _this._editor[row.type]}})],
					onClickCell: function(index, field) {
						if (index != _this.lastEditingIndex) {
							if (_this.endEditing()) {
								_this.$table.datagrid('selectRow', index).datagrid('beginEdit', index);
								var editor = _this.$table.datagrid('getEditor', {index: index, field: field});
				                if (editor){
				                    ($(editor.target).data('textbox') ? $(editor.target).textbox('textbox') : $(editor.target)).focus();
				                }
				                _this.lastEditingIndex = index;
							} else {
								_this.$table.datagrid('selectRow', _this.lastEditingIndex);
							}
						}
					},
					onEndEdit: function(index, row, changes) {
						for (var i = 0; i < headers.length; i ++) {
							var header = headers[i];
							if (header.type == 'integer' || header.type == 'long') {
								row[header.name] = parseInt(row[header.name]);
							} if (header.type == 'double') {
								row[header.name] = parseFloat(row[header.name]);
							} else {
								row[header.name] = String(row[header.name]);
							}
						}
					}
				});
			
				if (!_this._initEvent) {
					_this.$btnAdd.click(function() {
						_this.$table.datagrid('appendRow',{});
					});
					_this.$btnConfirm.click(function() {
						if (_this.endEditing()) {
							row.value = _this.$table.datagrid('getRows');
							Designer.PropBox.updateValue(index, row, true);
							_this.$window.window('close', true);
						}
					});
					_this.$btnCancel.click(function() {
						_this.$window.window('close', true);
					});
					_this.$btnRemove.click(function() {
						_this.$table.datagrid('deleteRow', _this.lastEditingIndex);
					});
					_this._initEvent = true;
				}
			},
			setValue: function(value) {
				editor.dataRows.$table.datagrid('loadData', value);
			},
			show: function() {
				editor.dataRows.$window.window('open', true);
			}
		}
		
		editor.fieldTable = {
				$window: $('#module-addField-editor-data-headers'),
				$table: $('#module-addField-editor-data-headers-table'),
				//$comboName: $('#module-addField-editor-data-headers-name'),
				$btnRemove:$('#module-addField-editor-data-headers-remove'),
				$btnAdds: $('#module-addField-editor-data-headers-add'),
				$btnConfirm: $('#module-tableinput-editor-params-confirm'),
				$btnCancel: $('#module-tableinput-editor-params-cancel'),
				endEditing: function() {
					var _this = editor.fieldTable;
					if (_this.lastEditingIndex == null) return true;
					if (_this.$table.datagrid('validateRow', _this.lastEditingIndex)) {
						_this.$table.datagrid('endEdit', _this.lastEditingIndex);
						_this.lastEditingIndex = null;
						return true;
					}
					return false;
				},
				 _editor: {string: {type: 'textbox'}, integer: {type: 'numberbox'}, long: {type: 'numberbox'}},
				init: function(index, row) {
					var _this = editor.fieldTable;
					var headers = Designer.PropBox.current.data('dataHeaders')
					if (!_this._initEvent) {
						_this.$table.datagrid({
							onClickCell: function(index, field) {
								if (index != _this.lastEditingIndex) {
									if (_this.endEditing()) {
										_this.$table.datagrid('selectRow', index).datagrid('beginEdit', index);
										var editor = _this.$table.datagrid('getEditor', {index: index, field: field});
						                if (editor){
						                    ($(editor.target).data('textbox') ? $(editor.target).textbox('textbox') : $(editor.target)).focus();
						                }
						                _this.lastEditingIndex = index;
									} else {
										_this.$table.datagrid('selectRow', _this.lastEditingIndex);
									}
								}
							}
						});
						_this.$btnAdds.click(function() {
							_this.$table.datagrid('appendRow',{name: '', type: '',datatype:''});
						});
						_this.$btnConfirm.click(function() {
							if (_this.endEditing()) {
								row.value = _this.$table.datagrid('getRows');
								Designer.PropBox.updateValue(index, row, true);
								_this.$window.window('close', true);
							}
						});
						_this.$btnCancel.click(function() {
							editor.fieldTable.$window.window('close', true);
						});
						_this.$btnRemove.click(function() {
							_this.$table.datagrid('deleteRow', _this.lastEditingIndex);
						});
						_this._initEvent = true;
					}
				},
				setValue: function(value) {
						editor.fieldTable.$table.datagrid('loadData', value);
				},
				show: function() {
					editor.fieldTable.$window.window('open', true);
				} 
			}
		
		
		editor.dataMappers = {
			$window: $('#module-tableinput-editor-data-mappers'),
			$table: $('#module-tableinput-editor-data-mappers-table'),
			$comboName: $('#module-tableinput-editor-data-mappers-name'),
			$btnAdd: $('#module-tableinput-editor-data-mappers-add'),
			$btnConfirm: $('#module-tableinput-editor-data-mappers-confirm'),
			$btnCancel: $('#module-tableinput-editor-data-mappers-cancel'),
			endEditing: function() {
				var _this = editor.dataMappers;
				if (_this.lastEditingIndex == null) return true;
				if (_this.$table.datagrid('validateRow', _this.lastEditingIndex)) {
					_this.$table.datagrid('endEdit', _this.lastEditingIndex);
					_this.lastEditingIndex = null;
					return true;
				}
				return false;
			},
			_editor: {string: {type: 'textbox'}, integer: {type: 'numberbox'}, long: {type: 'numberbox'}},
			init: function(index, row) {
				var _this = editor.dataMappers;
				var headers = Designer.PropBox.current.data('dataHeaders')
				if (!_this._initEvent) {
					_this.$table.datagrid({
						onClickCell: function(index, field) {
							if (index != _this.lastEditingIndex) {
								if (_this.endEditing()) {
									_this.$table.datagrid('selectRow', index).datagrid('beginEdit', index);
									var editor = _this.$table.datagrid('getEditor', {index: index, field: field});
					                if (editor){
					                    ($(editor.target).data('textbox') ? $(editor.target).textbox('textbox') : $(editor.target)).focus();
					                }
					                _this.lastEditingIndex = index;
								} else {
									_this.$table.datagrid('selectRow', _this.lastEditingIndex);
								}
							}
						}
					});
					_this.$comboName.combobox({
						onSelect: function(record) {
							if (_this.lastSelectedIndex != undefined && _this.endEditing()) {
								_this._value[_this.lastSelectedIndex] = _this.$table.datagrid('getRows');
							}
							_this.$table.datagrid('loadData', _this._value[record.index]);
							_this.lastSelectedIndex = record.index;
						}
					});
					_this.$btnAdd.click(function() {
						_this.$table.datagrid('appendRow',{from: '', to: ''});
					});
					_this.$btnConfirm.click(function() {
						if (_this.endEditing()) {
							row.value = _this._value;
							Designer.PropBox.updateValue(index, row, true);
							_this.$window.window('close', true);
						}
					});
					_this.$btnCancel.click(function() {
						_this.$window.window('close', true);
					});
					_this._initEvent = true;
				}
				_this.$comboName.combobox('loadData', headers.map(function(row, index) {return {name: row.name, index: index}}));
				_this._value = headers.map(function() {return []});
				if (headers.length > 0) {
					_this.$comboName.combobox('select', headers[0].name);
				}
			},
			setValue: function(value) {
				for (var i = 0; i <　value.length; i ++) {
					editor.dataMappers._value[i] = value[i];
				}
			},
			show: function() {
				editor.dataMappers.$window.window('open', true);
			}
		}
		
		editor.dataPaths = {
			$window: $('#module-tableinput-editor-data-paths'),
			$table: $('#module-tableinput-editor-data-paths-table'),
			$btnAdd: $('#module-tableinput-editor-data-paths-add'),
			$btnConfirm: $('#module-tableinput-editor-data-paths-confirm'),
			$btnCancel: $('#module-tableinput-editor-data-paths-cancel'),
			endEditing: function() {
				var _this = editor.dataPaths;
				if (_this.lastEditingIndex == null) return true;
				if (_this.$table.datagrid('validateRow', _this.lastEditingIndex)) {
					_this.$table.datagrid('endEdit', _this.lastEditingIndex);
					_this.lastEditingIndex = null;
					return true;
				}
				return false;
			},
			init: function(index, row) {
				var _this = editor.dataPaths;
				if (!_this._initEvent) {
					_this.$table.datagrid({
						onClickCell: function(index, field) {
							if (index != _this.lastEditingIndex) {
								if (_this.endEditing()) {
									_this.$table.datagrid('selectRow', index).datagrid('beginEdit', index);
									var editor = _this.$table.datagrid('getEditor', {index: index, field: field});
					                if (editor){
					                    ($(editor.target).data('textbox') ? $(editor.target).textbox('textbox') : $(editor.target)).focus();
					                }
					                _this.lastEditingIndex = index;
								} else {
									_this.$table.datagrid('selectRow', _this.lastEditingIndex);
								}
							}
						}
					});
					_this.$btnAdd.click(function() {
						_this.$table.datagrid('appendRow',{name: '', xpath: '', regex: ''});
					});
					_this.$btnConfirm.click(function() {
						if (_this.endEditing()) {
							row.value = _this.$table.datagrid('getRows');
							Designer.PropBox.updateValue(index, row, true);
							_this.$window.window('close', true);
						}
					});
					_this.$btnCancel.click(function() {
						_this.$window.window('close', true);
					});
					_this._initEvent = true;
				}
			},
			setValue: function(value) {
				editor.dataPaths.$table.datagrid('loadData', value);
			},
			show: function() {
				editor.dataPaths.$window.window('open', true);
			}
		}
		
		editor.procFields = {
			$window: $('#module-tableinput-editor-proc-fields'),
			$table: $('#module-tableinput-editor-proc-fields-table'),
			$btnConfirm: $('#module-tableinput-editor-proc-fields-confirm'),
			$btnCancel: $('#module-tableinput-editor-proc-fields-cancel'),
			endEditing: function() {
				var _this = editor.procFields;
				if (_this.lastEditingIndex == null) return true;
				if (_this.$table.datagrid('validateRow', _this.lastEditingIndex)) {
					_this.$table.datagrid('endEdit', _this.lastEditingIndex);
					_this.lastEditingIndex = null;
					return true;
				}
				return false;
			},
			init: function(index, row) {
				var _this = editor.procFields;
				if (!_this._initEvent) {
					_this.$table.datagrid({
						onClickCell: function(index, field) {
							if (index != _this.lastEditingIndex) {
								if (_this.endEditing()) {
									_this.$table.datagrid('selectRow', index).datagrid('beginEdit', index);
									var editor = _this.$table.datagrid('getEditor', {index: index, field: field});
					                if (editor){
					                    ($(editor.target).data('textbox') ? $(editor.target).textbox('textbox') : $(editor.target)).focus();
					                }
					                _this.lastEditingIndex = index;
								} else {
									_this.$table.datagrid('selectRow', _this.lastEditingIndex);
								}
							}
						}
					});
					_this.$btnConfirm.click(function() {
						if (_this.endEditing()) {
							row.value = _this.$table.datagrid('getRows');
							Designer.PropBox.updateValue(index, row, true);
							_this.$window.window('close', true);
						}
					});
					_this.$btnCancel.click(function() {
						_this.$window.window('close', true);
					});
					_this._initEvent = true;
				}
			},
			setValue: function(value) {
				var procName = Designer.PropBox.current.data('procName');
				var fields = [], newValue = [];
				if (procName == 'test') {
					fields = [{
						name: 'title',
						from: ''
					},{
						name: 'content',
						from: ''
					}];
				}
				
				if (procName == 'save_or_update_user') {
					fields = [{name:'name',	from:'name'},{
							name:'gender',from:'gender'},{
							name:'nation',from:'nation'},{
							name:'mobile',from:'mobile'},{
							name:'email',from:'email'},{
							name:'experienceCode',from:'experienceCode'},{
							name:'educationCode',from:'educationCode'},{
							name:'household',from:'household'},{
							name:'categoryCode',from:'categoryCode'},{
							name:'status',from:'status'},{
							name:'marriage',from:'marriage'},{
							name:'certType',from:'certType'},{
							name:'certId',from:'certId'},{
							name:'birth',from:'birth'},{
							name:'selfComment',from:'selfComment'},{
							name:'locationCode',from:'locationCode'},{
							name:'dataSrc',from:'dataSrc'},{
							name:'dataKey',from:'dataKey'},{
							name:'updateDate',from:'updateDate'},{
							name:'createDate',from:'createDate'},{
							name:'account',from:'account'},{
							name:'currEnt',from:'currEnt'},{
							name:'currEntPhone',from:'currEntPhone'},{
							name:'currPostCode',from:'currPostCode'},{
							name:'currPost',from:'currPost'},{
							name:'lbsLon',from:'lbsLon'},{
							name:'lbsLat',from:'lbsLat'},{
							name:'accountStatus',from:'accountStatus'}];


				}
				if(procName == 'save_or_update_ent') {
					fields = 	   [{name: ' name ',from:'name'},{
					    name: ' categoryCode ',from:'categoryCode'},{
					        name: ' natureCode ',from:'natureCode'},{
					        name: ' scaleCode ',from:'scaleCode'},{
					        name: ' tag ',from:'tag'},{
					        name: ' establish ',from:'establish'},{
					        name:  'troduction ',from:'troduction'},{
					        name: ' address ',from:'address'},{
					        name: ' website ',from:'website'},{
					        name: ' areaCode ',from:'areaCode'},{
					        name: ' lbsLon ',from:'lbsLon'},{
					        name: ' lbsLat ',from:'lbsLat'},{
					        name: ' organame:',from:'organame'},{
					        name: ' license ',from:'license'},{
					        name: ' contacter ',from:'contacter'},{
					        name: ' publicContact ',from:'publicContact'},{
					        name: ' phone ',from:'phone'},{
					        name: ' fax ',from:'fax'},{
					        name: ' mobile ',from:'mobile'},{
					        name: ' email ',from:'email'},{
					        name: ' qq ',from:'qq'},{
					        name: ' dataSrc ',from:'dataSrc'},{
					        name: ' dataKey ',from:'dataKey'},{
					        name: ' dataUrl ',from:'dataUrl'},{
					        name: ' updateDate ',from:'updateDate'},{
					        name: ' createDate ',from:'createDate'},{
					        name: ' account ',from:'account'}]
				}
				if(procName == 'save_or_update_post') {
					fields = 	  
						[{name:'NAME',from:'NAME'},
						 {name:'categoryCode',from:'categoryCode'},
						 {name:'natureCode',from:'natureCode'},
						 {name:'headcount',from:'headcount'},
						 {name:'age',from:'age'},
						 {name:'gender',from:'gender'},
						 {name:'salary',from:'salary'},
						 {name:'tag',from:'tag'},
						 {name:'troduction',from:'troduction'},
						 {name:'areaCode',from:'areaCode'},
						 {name:'address',from:'address'},
						 {name:'lbsLon',from:'lbsLon'},
						 {name:'lbsLat',from:'lbsLat'},
						 {name:'dataSrc',from:'dataSrc'},
						 {name:'dataKey',from:'dataKey'},
						 {name:'dataEntKey',from:'dataEntKey'},
						 {name:'dataUrl',from:'dataUrl'},
						 {name:'updateDate',from:'updateDate'},
						 {name:'createDate',from:'createDate'},
						 {name:'experienceCode',from:'experienceCode'},
						 {name:'educationCode',from:'educationCode'}]
				 }
				
				for (var i = 0; i < fields.length; i ++) {
					var exist = false;
					for (var j = 0; j < value.length; j ++) {
						if (fields[i].name == value[j].name) {
							exist = true;
							newValue.push(value[j]);
							break;
						}
					}
					if (!exist) {
						newValue.push(fields[i]);
					}
				}
				editor.procFields.$table.datagrid('loadData', newValue);
			},
			show: function() {
				editor.procFields.$window.window('open', true);
			}
		};

		editor.tableFields = {
			$window: $('#module-tableinput-editor-proc-fields'),
			$table: $('#module-tableinput-editor-proc-fields-table'),
			$btnConfirm: $('#module-tableinput-editor-proc-fields-confirm'),
			$btnCancel: $('#module-tableinput-editor-data-paths-cancel'),
			endEditing: function() {
				var _this = editor.tableFields;
				if (_this.lastEditingIndex == null) return true;
				if (_this.$table.datagrid('validateRow', _this.lastEditingIndex)) {
					_this.$table.datagrid('endEdit', _this.lastEditingIndex);
					_this.lastEditingIndex = null;
					return true;
				}
				return false;
			},
			init: function(index, row) {
				var _this = editor.tableFields;
				if (!_this._initEvent) {
					_this.$table.datagrid({
						onClickCell: function(index, field) {
							if (index != _this.lastEditingIndex) {
								if (_this.endEditing()) {
									_this.$table.datagrid('selectRow', index).datagrid('beginEdit', index);
									var editor = _this.$table.datagrid('getEditor', {index: index, field: field});
					                if (editor){
					                    ($(editor.target).data('textbox') ? $(editor.target).textbox('textbox') : $(editor.target)).focus();
					                }
					                _this.lastEditingIndex = index;
								} else {
									_this.$table.datagrid('selectRow', _this.lastEditingIndex);
								}
							}
						}
					});
					_this.$btnConfirm.click(function() {
						if (_this.endEditing()) {
							row.value = _this.$table.datagrid('getRows');
							Designer.PropBox.updateValue(index, row, true);
							_this.$window.window('close', true);
						}
					});
					_this.$btnCancel.click(function() {
						_this.$window.window('close', true);
					});
					_this._initEvent = true;
				}
			},
			setValue: function(value) {
				var tableName = Designer.PropBox.current.data('tableName');
				var fields = [], newValue = [];
				if (tableName == '') {
					fields = [{
						name: 'title',
						from: ''
					},{
						name: 'content',
						from: ''
					}];
				}
				
				if (tableName == 'blog') {
					fields = [{name:'title',from:'title'},{
							name:'content',from:'content'},{
							name:'test',from:'test'}
							];
				}
				if (tableName == 'db_enterprise') {
					fields = [{name:'name',from:'name'},{name:'account',from:'account'},{name:'category',from:'category'},{name:'category_code',from:'category_code'},{name:'nature',from:'nature'},{name:'nature_code',from:'nature_code'},{name:'scale',from:'scale'},{name:'scale_code',from:'scale_code'},{name:'tag',from:'tag'},{name:'establish',from:'establish'},{name:'introduction',from:'introduction'},{name:'area',from:'area'},{name:'area_code',from:'area_code'},{name:'address',from:'address'},{name:'lbs_lon',from:'lbs_lon'},{name:'lbs_lat',from:'lbs_lat'},{name:'website',from:'website'},{name:'orgains',from:'orgains'},{name:'license',from:'license'},{name:'contacter',from:'contacter'},{name:'public_contact',from:'public_contact'},{name:'phone',from:'phone'},{name:'fax',from:'fax'},{name:'mobile',from:'mobile'},{name:'email',from:'email'},{name:'qq',from:'qq'},{name:'visit_count',from:'visit_count'},{name:'data_src',from:'data_src'},{name:'data_key',from:'data_key'},{name:'data_url',from:'data_url'},{name:'data_status',from:'data_status'},{name:'update_date',from:'update_date'},{name:'create_date',from:'create_date'},{name:'syn_status',from:'syn_status' }
							];
				}
				if (tableName == 'db_entpost') {
					fields = [
								{name:'name',from:'name'},{
								name:'category',from:'category'},{
								name:'category_code',from:'category_code'},{
								name:'nature',from:'nature'},{
								name:'nature_code',from:'nature_code'},{
								name:'headcount',from:'headcount'},{
								name:'age',from:'age'},{
								name:'gender',from:'gender'},{
								name:'salary',from:'salary'},{
								name:'experience',from:'experience'},{
								name:'experience_code',from:'experience_code'},{
								name:'education',from:'education'},{
								name:'education_code',from:'education_code'},{
								name:'tag',from:'tag'},{
								name:'introduction',from:'introduction'},{
								name:'area',from:'area'},{
								name:'area_code',from:'area_code'},{
								name:'address',from:'address'},{
								name:'lbs_lon',from:'lbs_lon'},{
								name:'lbs_lat',from:'lbs_lat'},{
								name:'data_src',from:'data_src'},{
								name:'data_key',from:'data_key'},{
								name:'data_ent_key',from:'data_ent_key'},{
								name:'data_url',from:'data_url'},{
								name:'data_status',from:'data_status'},{
								name:'update_date',from:'update_date'},{
								name:'create_date',from:'create_date'},{
								name:'syn_status',from:'syn_status'}];
				}
				for (var i = 0; i < fields.length; i ++) {
					var exist = false;
					for (var j = 0; j < value.length; j ++) {
						if (fields[i].name == value[j].name) {
							exist = true;
							newValue.push(value[j]);
							break;
						}
					}
					if (!exist) {
						newValue.push(fields[i]);
					}
				}
				editor.tableFields.$table.datagrid('loadData', newValue);
			},
			show: function() {
				editor.tableFields.$window.window('open', true);
			}
		}

		editor.procName = {
			fixed: true,
			type: 'combobox',
			options: {
				textField: 'text',
				valueField: 'value',
				data: [{
					text: 'save_or_update_post',
					value: 'save_or_update_post'
				},{
					text: 'save_or_update_ent',
					value: 'save_or_update_ent'
				}]
			}
		};
		
		editor.jdbcUrl = {
				fixed: true,
				type: 'combobox',
				options: {
					textField: 'text',
					valueField: 'value',
					data: [{
						text: '测试数据库zcdh_uni_test',
						value: 'jdbc:mysql://192.168.1.30:3306/zcdh_uni_test?useUnicode=true&characterEncoding=utf8&autoReconnect=true&autoReconnectForPools=true'
					}]
				}
			};
		
		editor.interfaceName = {
				fixed: true,
				type: 'combobox',
				options: {
					textField: 'text',
					valueField: 'value',
					data: [{
						text: '用人单位信息查询',
						value: 'hbjyweb_webservice_cb20_xml_task'
					},{
						text: '招聘岗位信息查询',
						value: 'hbjyweb_webservice_cb21_xml_task'
					},{
						text: '个人信息查询',
						value: 'hbjyweb_webservice_cc20_xml_task'
					}],
					onSelect: function(record){
						if(record.value='hbjyweb_webservice_cb20_xml_task'){
							Designer.PropBox.updateValue(9, {
								editor: 'text',
								name: 'params',
								value: [ {
									name: 'AAB003',
									type: 'string',
									editor: 'textbox',
									options: ''
								}, {
									name: 'AAB004',
									type: 'string',
									editor: 'textbox',
									options: ''
								},{
									name: 'AAB003',
									type: 'string',
									editor: 'textbox',
									options: ''
								},{
									name: 'AAE022',
									type: 'string',
									editor: 'textbox',
									options: ''
								},{
									name: 'AAF036_1',
									type: 'string',
									editor: 'textbox',
									options: ''
								},{
									name: 'AAF036_2',
									type: 'string',
									editor: 'textbox',
									options: ''
								}]
							}, true);
						}else if(record.value='hbjyweb_webservice_cb21_xml_task'){
							Designer.PropBox.updateValue(9, {
								editor: 'text',
								name: 'params',
								value: [ {
									name: 'ACB217',
									type: 'string',
									editor: 'textbox',
									options: ''
								}, {
									name: 'ACA111',
									type: 'string',
									editor: 'textbox',
									options: ''
								},{
									name: 'AAF036_1',
									type: 'string',
									editor: 'textbox',
									options: ''
								},{
									name: 'AAF036_2',
									type: 'string',
									editor: 'textbox',
									options: ''
								},
								{
									name: 'AAE022',
									type: 'string',
									editor: 'textbox',
									options: ''
								}]
							}, true);
						}else if(record.value='hbjyweb_webservice_cc20_xml_task'){
							Designer.PropBox.updateValue(9, {
								editor: 'text',
								name: 'params',
								value: [ {
									name: 'AAC002',
									type: 'string',
									editor: 'textbox',
									options: ''
								}]
							}, true);
						}
					}
				}
			};

		editor.tableName = {
			fixed: true,
			type: 'combobox',
			options: {
				textField: 'text',
				valueField: 'value',
				data: [{
					text: 'db_entpost',
					value: 'db_entpost'
				},
				{
					text: 'db_enterprise',
					value: 'db_enterprise'
				}]
			}
		};

		editor.excelFile = {
			fixed: true,
			type: 'combobox',
			options: {
				textField: 'name',
				valueField: 'name',
				url: '${ctx}/data/file?ftype=excelmapper'
			}
		};

		editor.params = {
			$window: $('#module-tableinput-editor-params'),
			$table: $('#module-tableinput-editor-params-table'),
			$btnConfirm: $('#module-tableinput-editor-params-confirm'),
			$btnCancel: $('#module-tableinput-editor-params-cancel'),
			endEditing: function() {
				var _this = editor.params;
				if (_this.lastEditingIndex == null) return true;
				if (_this.$table.datagrid('validateRow', _this.lastEditingIndex)) {
					_this.$table.datagrid('endEdit', _this.lastEditingIndex);
					_this.lastEditingIndex = null;
					return true;
				}
				return false;
			},
			init: function(index, row) {
				var _this = editor.params;
				if (!_this._initEvent) {
					_this.$table.datagrid({
						onClickCell: function(index, field) {
							if (index != _this.lastEditingIndex) {
								if (_this.endEditing()) {
									_this.$table.datagrid('selectRow', index).datagrid('beginEdit', index);
									var editor = _this.$table.datagrid('getEditor', {index: index, field: field});
					                if (editor) {
					                	var $editor = $(editor.target), paramType = row.value[index].type;
					                	if (field == 'editor') {
					                		if (paramType == 'string') {
						                		$editor.combobox('loadData', [
						                			{name:'文本框', value:'textbox'},
						                			{name:'下拉框', value:'combobox'}
						                		]);
						                	} else if (paramType == 'integer') {
						                		$editor.combobox('loadData', [
						                			{name:'数字框', value:'numberspinner'},
						                			{name:'下拉框', value:'combobox'}
						                		]);
						                	} else if (paramType == 'file') {
						                		$editor.combobox('loadData', [
						                			{name:'文件框', value:'filebox'}
						                		]);
						                	} else if (paramType == 'date') {
						                		$editor.combobox('loadData', [
						                			{name:'日期框', value:'datebox'}
						                		]);
						                	} else {
						                		$editor.combobox('loadData', []);
						                	}
					                	}
					                    ($editor.data('textbox') ? $editor.textbox('textbox') : $editor).focus();
					                }
					                _this.lastEditingIndex = index;
								} else {
									_this.$table.datagrid('selectRow', _this.lastEditingIndex);
								}
							}
						}
					});
					_this.$btnConfirm.click(function() {
						if (_this.endEditing()) {
							row.value = _this.$table.datagrid('getRows');
							for (var i = 0; i < row.value.length; i ++) {
								if (/^\[[\w\W]*\]$/.test(row.value[i].options)) {
									row.value[i].options = JSON.parse(row.value[i].options);
								}
							}
							Designer.PropBox.updateValue(index, row, true);
							_this.$window.window('close', true);
						}
					});
					_this.$btnCancel.click(function() {
						_this.$window.window('close', true);
					});
					_this._initEvent = true;
				}
			},
			setValue: function(value) {
				for (var i = 0; i < value.length; i ++) {
					if ($.isArray(value[i].options)) {
						value[i].options = JSON.stringify(value[i].options);
					}
				}
				editor.params.$table.datagrid('loadData', value);
				/* if(interfaceName="hbjyweb_webservice_cb20_xml_task"){
					fields = [
								{name:'name',from:'name'},{
								name:'category',from:'category'},{
								name:'category_code',from:'category_code'},{
								name:'nature',from:'nature'},{
								name:'nature_code',from:'nature_code'},{
								name:'headcount',from:'headcount'},{
								name:'age',from:'age'},{
								name:'gender',from:'gender'},{
								name:'salary',from:'salary'},{
								name:'experience',from:'experience'},{
								name:'experience_code',from:'experience_code'},{
								name:'education',from:'education'},{
								name:'education_code',from:'education_code'},{
								name:'tag',from:'tag'},{
								name:'introduction',from:'introduction'},{
								name:'area',from:'area'},{
								name:'area_code',from:'area_code'},{
								name:'address',from:'address'},{
								name:'lbs_lon',from:'lbs_lon'},{
								name:'lbs_lat',from:'lbs_lat'},{
								name:'data_src',from:'data_src'},{
								name:'data_key',from:'data_key'},{
								name:'data_ent_key',from:'data_ent_key'},{
								name:'data_url',from:'data_url'},{
								name:'data_status',from:'data_status'},{
								name:'update_date',from:'update_date'},{
								name:'create_date',from:'create_date'},{
								name:'syn_status',from:'syn_status'}];
				} */
				
				
				
				/* for (var i = 0; i < fields.length; i ++) {
					var exist = false;
					for (var j = 0; j < value.length; j ++) {
						if (fields[i].name == value[j].name) {
							exist = true;
							newValue.push(value[j]);
							break;
						}
					}
					if (!exist) {
						newValue.push(fields[i]);
					}
				}
				editor.tableFields.$table.datagrid('loadData', newValue);
				 */
			},
			show: function() {
				editor.params.$window.window('open', true);
			}
		}

		Designer.init(
			'process-designer-tabs', 'process-designer-tabs-canvas', 'process-designer-tabs-content', 
			'precess-designer-toolbox-moveable', 'precess-designer-toolbox-citem', 
			'process-designer-prop-form', 'process-designer-prop-box',
			editor
		);
		$('#process-designer-toolbox-save').click(function() {
			var data = Designer.getData();
			var processId = '${process?if_exists}';
			$.post('${ctx}/process/save', {
				process: processId,
				content: JSON.stringify(data)
			}, function(data) {
				if (data.success) {
					$.messager.show({
						title: '提示',
						msg: '保存成功！',
						timeout: 1000,
						showType: 'slide'
					});
				} else {
					$.messager.show({
						title: '提示',
						msg: '保存失败！',
						timeout: 1000,
						showType: 'slide'
					});
				}
			}, 'json');
		});
		$('#process-designer-toolbox-ele-delete').click(function() {
			Designer.eleDelete();
		});
		var content = ${content!"false"};
		if (content) {
			Designer.setData(content);
		}
	});
</script>
</body>
</html>