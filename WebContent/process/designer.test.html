<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Snaker</title>
<script type="text/javascript" src="../common/jquery.min.js"></script>
<link rel="stylesheet" type="text/css" href="../common/easyui/themes/default/easyui.css">
<link rel="stylesheet" type="text/css" href="../common/easyui/themes/icon.css">
<script type="text/javascript" src="../common/easyui/jquery.easyui.min.js"></script>
<script type="text/javascript" src="../common/easyui/locale/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="../common/raphael-min.js"></script>
<script type="text/javascript" src="../common/snaker.designer.js"></script>
</head>
<body>
<div class="easyui-layout" data-options="fit:true">
	<div id="precess-designer-toolbox" data-options="region:'west',split:true,title:'工具'" style="width:80px;text-align:center">
		<br /><a id="process-designer-toolbox-save" class="easyui-linkbutton">保存</a><br />
		<br /><input id="precess-designer-toolbox-moveable" class="easyui-switchbutton" data-options="onText:'移动',offText:'连线'" style="width:80%;margin:10px;padding:10px;" checked><br /><br />
		<div class="easyui-accordion" data-options="fit:true,border:false">
			<div data-options="title:'通用'" style="text-align:center;padding-left:10px;padding-top:10px">
				<p class="precess-designer-toolbox-citem" data-mtype="begin" style="width:50px;height:20px;line-height:20px;background:#fafafa">开始</p>
				<p class="precess-designer-toolbox-citem" data-mtype="end" style="width:50px;height:20px;line-height:20px;background:#fafafa">结束</p>
				<p class="precess-designer-toolbox-citem" data-mtype="tableinput" style="width:50px;height:20px;line-height:20px;background:#fafafa">表格输入</p>
				<p class="precess-designer-toolbox-citem" data-mtype="tablemapper" style="width:50px;height:20px;line-height:20px;background:#fafafa">表格映射</p>
			</div>
		</div>
	</div>
	<div id="process-designer-tabs" class="easyui-tabs" data-options="region:'center'">
		<div id="process-designer-tabs-canvas" data-options="title:'画板'" style="position:absolute"></div>
		<div id="process-designer-tabs-content" data-options="title:'内容'">{}</div>
	</div>
	<div data-options="region:'east',split:true,title:'履带'" style="width:180px">
		<form id="process-designer-prop-form" style="height:50px">
			<br />
			名称：<input type="text" class="easyui-textbox" style="width:120px" name="name"></input>
		</form>
		<table id="process-designer-prop-box" class="easyui-propertygrid" data-options="columns:[[{field:'name',title:'名称'},{field:'value',title:'内容',width:100}]],fix:true"></table>
	</div>
</div>


<div id="module-tableinput-editor-data-headers" class="easyui-window" data-options="title:'头定义',modal:true,closed:true,footer:'#module-tableinput-editor-data-headers-footer'" style="width:600px;height:500px">
	<table id="module-tableinput-editor-data-headers-table" class="easyui-datagrid" data-options="toolbar:'#module-tableinput-editor-data-headers-toolbar'">
		<thead>
			<tr>
				<th data-options="field:'name',width:100,editor:{type:'textbox'}">名称</th>
				<th data-options="field:'type',width:100,formatter:function(v,r){var options=this.editor.options;for(var i=0;i<options.data.length;i++){if(options.data[i][options.valueField]==v)return options.data[i][options.textField]}return ''},editor:{type:'combobox',options:{textField:'name',valueField:'value',data:[{name:'字符串',value:'string'},{name:'整形',value:'integer'},{name:'长整形',value:'long'}]}}">类型</th>
				<th data-options="field:'format',width:100,editor:{type:'textbox'}">格式</th>
			</tr>
		</thead>
	</table>
	<div id="module-tableinput-editor-data-headers-toolbar">
		<a id="module-tableinput-editor-data-headers-add" class="easyui-linkbutton">新增</a>
	</div>
</div>
<div id="module-tableinput-editor-data-headers-footer" style="padding:5px;">
	<a id="module-tableinput-editor-data-headers-confirm" class="easyui-linkbutton" style="width:80px">确定</a>
	<a id="module-tableinput-editor-data-headers-cancel" class="easyui-linkbutton" style="width:80px">取消</a>
</div>


<div id="module-tableinput-editor-data-rows" class="easyui-window" data-options="title:'表数据',modal:true,closed:true,footer:'#module-tableinput-editor-data-rows-footer'" style="width:600px;height:500px">
	<table id="module-tableinput-editor-data-rows-table" class="easyui-datagrid" data-options="toolbar:'#module-tableinput-editor-data-rows-toolbar'"></table>
	<div id="module-tableinput-editor-data-rows-toolbar">
		<a id="module-tableinput-editor-data-rows-add" class="easyui-linkbutton">新增</a>
	</div>
</div>
<div id="module-tableinput-editor-data-rows-footer" style="padding:5px;">
	<a id="module-tableinput-editor-data-rows-confirm" class="easyui-linkbutton" style="width:80px">确定</a>
	<a id="module-tableinput-editor-data-rows-cancel" class="easyui-linkbutton" style="width:80px">取消</a>
</div>


<div id="module-tableinput-editor-data-mappers" class="easyui-window" data-options="title:'表映射',modal:true,closed:true,footer:'#module-tableinput-editor-data-mappers-footer'" style="width:600px;height:500px">
	<table id="module-tableinput-editor-data-mappers-table" class="easyui-datagrid" data-options="toolbar:'#module-tableinput-editor-data-mappers-toolbar'">
		<thead>
			<tr>
				<th data-options="field:'from',width:100,editor:{type:'textbox'}">从</th>
				<th data-options="field:'to',width:100,editor:{type:'textbox'}">到</th>
			</tr>
		</thead>
	</table>
	<div id="module-tableinput-editor-data-mappers-toolbar">
		字段：<input id="module-tableinput-editor-data-mappers-name" class="easyui-combobox" data-options="valueField:'name',textField:'name'">
		<a id="module-tableinput-editor-data-mappers-add" class="easyui-linkbutton">新增</a>
	</div>
</div>
<div id="module-tableinput-editor-data-mappers-footer" style="padding:5px;">
	<a id="module-tableinput-editor-data-mappers-confirm" class="easyui-linkbutton" style="width:80px">确定</a>
	<a id="module-tableinput-editor-data-mappers-cancel" class="easyui-linkbutton" style="width:80px">取消</a>
</div>
<script type="text/javascript">
	$(function() {
		
		var editor = {};
		
		editor.dataHeaders = {
			$window: $('#module-tableinput-editor-data-headers'),
			$table: $('#module-tableinput-editor-data-headers-table'),
			$btnAdd: $('#module-tableinput-editor-data-headers-add'),
			$btnConfirm: $('#module-tableinput-editor-data-headers-confirm'),
			$btnCancel: $('#module-tableinput-editor-data-headers-cancel'),
			endEditing: function() {
				var _this = editor.dataHeaders;
				if (_this.lastEditingIndex == null) return true;
				if (_this.$table.datagrid('validateRow', _this.lastEditingIndex)) {
					_this.$table.datagrid('endEdit', _this.lastEditingIndex);
					_this.lastEditingIndex = null;
					return true;
				}
				return false;
			},
			init: function(index, row) {
				var _this = editor.dataHeaders;
				if (!_this._initEvent) {
					_this.$table.datagrid({
						onClickCell: function(index, field) {
							if (index != _this.lastEditingIndex) {
								if (_this.endEditing()) {
									_this.$table.datagrid('selectRow', index).datagrid('beginEdit', index);
									var editor = _this.$table.datagrid('getEditor', {index: index, field: field});
					                if (editor){
					                    ($(editor.target).data('textbox') ? $(editor.target).textbox('textbox') : $(editor.target)).focus();
					                }
					                _this.lastEditingIndex = index;
								} else {
									_this.$table.datagrid('selectRow', _this.lastEditingIndex);
								}
							}
						}
					});
					_this.$btnAdd.click(function() {
						_this.$table.datagrid('appendRow',{type: 'string'});
					});
					_this.$btnConfirm.click(function() {
						if (_this.endEditing()) {
							row.value = JSON.stringify(_this.$table.datagrid('getRows'));
							Designer.PropBox.updateValue(index, row, true);
							_this.$window.window('close', true);
						}
					});
					_this.$btnCancel.click(function() {
						_this.$window.window('close', true);
					});
					_this._initEvent = true;
				}
			},
			setValue: function(value) {
				editor.dataHeaders.$table.datagrid('loadData', JSON.parse(value));
			},
			show: function() {
				editor.dataHeaders.$window.window('open', true);
			}
		}
		
		editor.dataRows = {
			$window: $('#module-tableinput-editor-data-rows'),
			$table: $('#module-tableinput-editor-data-rows-table'),
			$btnAdd: $('#module-tableinput-editor-data-rows-add'),
			$btnConfirm: $('#module-tableinput-editor-data-rows-confirm'),
			$btnCancel: $('#module-tableinput-editor-data-rows-cancel'),
			endEditing: function() {
				var _this = editor.dataRows;
				if (_this.lastEditingIndex == null) return true;
				if (_this.$table.datagrid('validateRow', _this.lastEditingIndex)) {
					_this.$table.datagrid('endEdit', _this.lastEditingIndex);
					_this.lastEditingIndex = null;
					return true;
				}
				return false;
			},
			_editor: {string: {type: 'textbox'}, integer: {type: 'numberbox'}, long: {type: 'numberbox'}},
			init: function(index, row) {
				var _this = editor.dataRows;
				var headers = JSON.parse(Designer.PropBox.current.data('dataHeaders'))
				_this.$table.datagrid({
					columns: [headers.map(function(row) {return {title: row.name, field: row.name, width: 100, editor: _this._editor[row.type]}})],
					onClickCell: function(index, field) {
						if (index != _this.lastEditingIndex) {
							if (_this.endEditing()) {
								_this.$table.datagrid('selectRow', index).datagrid('beginEdit', index);
								var editor = _this.$table.datagrid('getEditor', {index: index, field: field});
				                if (editor){
				                    ($(editor.target).data('textbox') ? $(editor.target).textbox('textbox') : $(editor.target)).focus();
				                }
				                _this.lastEditingIndex = index;
							} else {
								_this.$table.datagrid('selectRow', _this.lastEditingIndex);
							}
						}
					}
				});
				if (!_this._initEvent) {
					_this.$btnAdd.click(function() {
						_this.$table.datagrid('appendRow',{type: 'string'});
					});
					_this.$btnConfirm.click(function() {
						if (_this.endEditing()) {
							row.value = JSON.stringify(_this.$table.datagrid('getRows'));
							Designer.PropBox.updateValue(index, row, true);
							_this.$window.window('close', true);
						}
					});
					_this.$btnCancel.click(function() {
						_this.$window.window('close', true);
					});
					_this._initEvent = true;
				}
			},
			setValue: function(value) {
				editor.dataRows.$table.datagrid('loadData', JSON.parse(value));
			},
			show: function() {
				editor.dataRows.$window.window('open', true);
			}
		}
		
		editor.dataMappers = {
			$window: $('#module-tableinput-editor-data-mappers'),
			$table: $('#module-tableinput-editor-data-mappers-table'),
			$comboName: $('#module-tableinput-editor-data-mappers-name'),
			$btnAdd: $('#module-tableinput-editor-data-mappers-add'),
			$btnConfirm: $('#module-tableinput-editor-data-mappers-confirm'),
			$btnCancel: $('#module-tableinput-editor-data-mappers-cancel'),
			endEditing: function() {
				var _this = editor.dataMappers;
				if (_this.lastEditingIndex == null) return true;
				if (_this.$table.datagrid('validateRow', _this.lastEditingIndex)) {
					_this.$table.datagrid('endEdit', _this.lastEditingIndex);
					_this.lastEditingIndex = null;
					return true;
				}
				return false;
			},
			_editor: {string: {type: 'textbox'}, integer: {type: 'numberbox'}, long: {type: 'numberbox'}},
			init: function(index, row) {
				var _this = editor.dataMappers;
				var headers = JSON.parse(Designer.PropBox.current.data('dataHeaders'))
				_this.$comboName.combobox('loadData', headers.map(function(row, index) {return {name: row.name, index: index}}));
				_this._value = headers.map(function() {return []});
				if (headers.length > 0) {
					_this.$comboName.combobox('select', headers[0].name);
				}
				if (!_this._initEvent) {
					_this.$table.datagrid({
						onClickCell: function(index, field) {
							if (index != _this.lastEditingIndex) {
								if (_this.endEditing()) {
									_this.$table.datagrid('selectRow', index).datagrid('beginEdit', index);
									var editor = _this.$table.datagrid('getEditor', {index: index, field: field});
					                if (editor){
					                    ($(editor.target).data('textbox') ? $(editor.target).textbox('textbox') : $(editor.target)).focus();
					                }
					                _this.lastEditingIndex = index;
								} else {
									_this.$table.datagrid('selectRow', _this.lastEditingIndex);
								}
							}
						}
					});
					_this.$comboName.combobox({
						onSelect: function(record) {
							_this.$table.datagrid('loadData', _this._value[record.index]);
						},
						onUnselect: function(record) {
							_this._value[record.index] = _this.$table.datagrid('getRows');
						}
					});
					_this.$btnAdd.click(function() {
						_this.$table.datagrid('appendRow',{type: 'string'});
					});
					_this.$btnConfirm.click(function() {
						if (_this.endEditing()) {
							row.value = JSON.stringify(_this._value);
							Designer.PropBox.updateValue(index, row, true);
							_this.$window.window('close', true);
						}
					});
					_this.$btnCancel.click(function() {
						_this.$window.window('close', true);
					});
					_this._initEvent = true;
				}
			},
			setValue: function(value) {
				value = JSON.parse(value);
				for (var i = 0; i <　value.length; i ++) {
					editor.dataMappers._value[i] = value[i];
				}
			},
			show: function() {
				editor.dataMappers.$window.window('open', true);
			}
		}
		
		Designer.init(
			'process-designer-tabs', 'process-designer-tabs-canvas', 'process-designer-tabs-content', 
			'precess-designer-toolbox-moveable', 'precess-designer-toolbox-citem', 
			'process-designer-prop-form', 'process-designer-prop-box',
			editor
		);
		$('#process-designer-toolbox-save').click(function() {
			var data = Designer.getData()
			console.log(data);
		});
		/* var process = '${process}';
		var content = '${content}';
		if (content.indexOf('{content}') < 0) {
			Designer.setData(JSON.parse(content));
		} */
	});
</script>
</body>
</html>