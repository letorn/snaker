<table id="process-list-table" class="easyui-datagrid" data-options="rownumbers:true,toolbar:'#process-list-table-toolbar',fit:true">
	<thead>
		<tr>
			<th data-options="field:'id',width:60">流程编号</th>
			<th data-options="field:'name',width:150">流程名称</th>
			<th data-options="field:'content',width:680,formatter:$.encodeHtml">流程内容</th>
			<th data-options="field:'action',width:130,formatter:processListTableActionFormatter">操作</th>
		</tr>
	</thead>
</table>
<div id="process-list-table-toolbar" style="padding: 2px 5px;">
	<a id="process-list-table-init" class="easyui-linkbutton">初始化</a>
	<a id="process-list-table-designer" class="easyui-linkbutton">设计</a>
	<input id="process-list-table-search" class="easyui-searchbox" data-options="prompt:'流程显示名称'" style="width:200px"></input>
</div>


<div id="process-list-params-window" class="easyui-window" data-options="title:'启动',modal:true,closed:true,footer:'#process-list-params-window-footer'" style="width:600px;height:500px">

</div>
<div id="process-list-params-window-footer" style="padding:5px;">
	<a id="process-list-params-window-confirm" class="easyui-linkbutton" style="width:80px">运行</a>
	<a id="process-list-params-window-cancel" class="easyui-linkbutton" style="width:80px">取消</a>
</div>
<script type="text/javascript">
	function processListTableActionFormatter(value, row) {
		return '<a class="process-list-table-start" data-process="' + row.id + '" data-text="' + row.name + '" style="cursor:pointer;color:blue">启动</a>&nbsp;&nbsp;' +
				'<a class="process-list-table-design" data-process="' + row.id + '" style="cursor:pointer;color:blue">设计</a>&nbsp;&nbsp;' + 
				'<a class="process-list-table-delete" data-process="' + row.id + '" style="cursor:pointer;color:blue">删除</a>';
	}

	$.render(function() {
		var $processListTable = $('#process-list-table'), $processListParamsWindow = $('#process-list-params-window');
		
		$('#process-list-table-init').click(function() {
			$.getJSON('process/init', function(data) {
				if (data.success) {
					$.messager.show({
						title: '提示',
						msg: '初始化完成！',
						timeout: 1000,
						showType: 'slide'
					});
					$processListTable.datagrid('reload');
				} else {
					$.messager.show({
						title: '提示',
						msg: '初始化失败！',
						timeout: 1000,
						showType: 'slide'
					});
				}
			});
		});
		
		$('#process-list-table-designer').click(function() {
			window.open ('process/designer')
		});
		
		$('#process-list-table-search').searchbox({
			searcher: function(value) {
				$processListTable.datagrid('load', {
					name: value
				});
			}
		});
		
		$('#process-list-params-window-confirm').click(function() {
			var param = {};
			$processListParamsWindow.find('input,select').each(function(index, input) {
				var $input = $(input);
				var module = $input.data('module');
				var field = $input.data('field');
				if (module != undefined && field != undefined) {
					param[module] = param[module] || {};
					param[module][field] = $input.attr('type') == 'file' ? $input.data('val') : $input.val();
				}
			});
			$.getJSON('workflow/run/' + $processListParamsWindow.data('process'), function(data) {
				if (data.success) {
					$.messager.show({
						title: '提示',
						msg: '启动成功，请到待办任务就查看！',
						timeout: 1000,
						showType: 'slide'
					});
				} else {
					$.messager.show({
						title: '提示',
						msg: '启动失败！',
						timeout: 1000,
						showType: 'slide'
					});
				}
			});
			$processListParamsWindow.window('close');
		});
		
		$('#process-list-params-window-cancel').click(function() {
			$processListParamsWindow.window('close');
		});
		
		$processListTable.datagrid({
			url:'process',
			method:'get',
			onLoadSuccess: function() {
				$('.process-list-table-start').click(function() {
					$processListParamsWindow.data('process', $(this).data('process'));
					$processListParamsWindow.html('');
					$.getJSON('workflow/params/' + $(this).data('process'), function(data) {
						for (var i = 0; i < data.length; i ++) {
							var d = data[i];
							if (d.params) {
								$processListParamsWindow.append('<h3>' + d.module + '</h3>');
								for (var j = 0; j < d.params.length; j ++) {
									var param = d.params[j];
									if (param.editor == 'combobox') {
										var options = '';
										for (var k = 0; k < param.options.length; k ++) {
											options += '<option value="' + param.options[k][1] + '">' + param.options[k][0] + '</option>';
										}
										$processListParamsWindow.append('<span style="display:inline-block;width:100px">' + param.name + '：</span>' + '<select class="easyui-' + param.editor + '" data-module="' + d.module + '" data-field="' + param.name + '" style="width:173px">' + options + '</select><br />');
									} else if (param.editor == 'filebox') {
										$processListParamsWindow.append('<span style="display:inline-block;width:100px">' + param.name + '：</span>' + '<input id="process-list-params-window-' + d.module + '-' + param.name + '" data-module="' + d.module + '" data-field="' + param.name + '" type="file" name="file" /><br />');
									}else {
										$processListParamsWindow.append('<span style="display:inline-block;width:100px">' + param.name + '：</span>' + '<input class="easyui-' + param.editor + '" data-module="' + d.module + '" data-field="' + param.name + '" /><br />');
									}
								}
							}
						}
						$.parser.parse($processListParamsWindow);
						$processListParamsWindow.find('input[type=file]').change(function(newValue) {
							var $file = $(this);
							$.ajaxFileUpload({
								url: 'workflow/upload',
								fileElementId: $file.attr('id'),
								dataType: 'json',
								success: function(resp) {
									$file.data('val', resp.file);
								},
								error: function() {
									
								}
							});
						});
					});
					$processListParamsWindow.window('open');
				});
				
				$('.process-list-table-design').click(function() {
					window.open ('process/designer/' + $(this).data('process'));
				});
				
				$('.process-list-table-delete').click(function() {
					$.getJSON('process/delete/' + $(this).data('process'), function(data) {
						if (data.success) {
							$.messager.show({
								title: '提示',
								msg: '删除成功！',
								timeout: 1000,
								showType: 'slide'
							});
							$processListTable.datagrid('reload');
						} else {
							$.messager.show({
								title: '提示',
								msg: '删除失败！',
								timeout: 1000,
								showType: 'slide'
							});
						}
					});
				});
			}
		});
	});
</script>