<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>表格输入</title>
<script type="text/javascript" src="${ctx}/common/jquery.min.js"></script>
<link rel="stylesheet" type="text/css" href="${ctx}/common/easyui/themes/default/easyui.css">
<link rel="stylesheet" type="text/css" href="${ctx}/common/easyui/themes/icon.css">
<script type="text/javascript" src="${ctx}/common/easyui/jquery.easyui.min.js"></script>
<script type="text/javascript" src="${ctx}/common/easyui/locale/easyui-lang-zh_CN.js"></script>
</head>
<body>
<div class="easyui-layout" data-options="fit:true">
	<div id="module-tableinput-tabs" class="easyui-tabs" data-options="region:'center'">
		<div data-options="title:'表定义'">
			<table id="module-tableinput-define" class="easyui-datagrid" data-options="toolbar:'#module-tableinput-define-toolbar'">
				<thead>
					<tr>
						<th data-options="field:'name',width:100,editor:{type:'textbox'}">名称</th>
						<th data-options="field:'type',width:100,formatter:function(v,r){var options=this.editor.options;for(var i=0;i<options.data.length;i++){if(options.data[i][options.valueField]==v)return options.data[i][options.textField]}return ''},editor:{type:'combobox',options:{textField:'name',valueField:'value',data:[{name:'字符串',value:'string'},{name:'整形',value:'integer'},{name:'长整形',value:'long'}]}}">类型</th>
						<th data-options="field:'format',width:100,editor:{type:'textbox'}">格式</th>
					</tr>
				</thead>
			</table>
			<div id="module-tableinput-define-toolbar">
				<a id="module-tableinput-define-add" class="easyui-linkbutton">新增</a>
			</div>
		</div>
		<div data-options="title:'表数据'">
			<table id="module-tableinput-input" class="easyui-datagrid" data-options="toolbar:'#module-tableinput-input-toolbar'"></table>
			<div id="module-tableinput-input-toolbar">
				<a id="module-tableinput-input-add" class="easyui-linkbutton">新增</a>
			</div>
		</div>
	</div>
	<div data-options="region:'south',split:false" style="height:50px">
		<a id="module-tableinput-save" class="easyui-linkbutton" style="width:80px">提交</a>
	</div>
</div>
<script type="text/javascript">
	$(function() {
		var $moduleTableinputTabs = $('#module-tableinput-tabs'), $moduleTableinputDefine = $('#module-tableinput-define'), $moduleTableinputInput = $('#module-tableinput-input');
		var lastModuleTableinputDefineEditingIndex = null, lastModuleTableinputInputEditingIndex = null;
		
		function endModuleTableinputDefineEditing() {
			if (lastModuleTableinputDefineEditingIndex == null) return true;
            if ($moduleTableinputDefine.datagrid('validateRow', lastModuleTableinputDefineEditingIndex)){
                $moduleTableinputDefine.datagrid('endEdit', lastModuleTableinputDefineEditingIndex);
                lastModuleTableinputDefineEditingIndex = null;
                return true;
            }
            return false;
		}
		
		function endModuleTableinputInputEditing() {
			if (lastModuleTableinputInputEditingIndex == null) return true;
            if ($moduleTableinputInput.datagrid('validateRow', lastModuleTableinputInputEditingIndex)){
                $moduleTableinputInput.datagrid('endEdit', lastModuleTableinputInputEditingIndex);
                lastModuleTableinputInputEditingIndex = null;
                return true;
            }
            return false;
		}
		
		function reloadModuleTableinputInputData() {
			endModuleTableinputDefineEditing();
			endModuleTableinputInputEditing();
			var defines = $moduleTableinputDefine.datagrid('getRows');
			var inputs = $moduleTableinputInput.datagrid('getRows');
			var columns = [], data = inputs.total > 0 ? inputs.rows : [];
			var editor = {
					string: {
						type: 'textbox'
					},
					integer: {
						type: 'numberbox'
					},
					long: {
						type: 'numberbox'
					}
			}

			$moduleTableinputInput.datagrid({
				columns: [defines.map(function(row) {return {title: row.name, field: row.name, width: 100, editor: editor[row.type]}})],
				data: inputs,
				onClickCell: function(index, field) {
					if (index != lastModuleTableinputInputEditingIndex) {
						if (endModuleTableinputInputEditing()) {
							$moduleTableinputInput.datagrid('selectRow', index).datagrid('beginEdit', index);
							var editor = $moduleTableinputInput.datagrid('getEditor', {index: index, field: field});
			                if (editor){
			                    ($(editor.target).data('textbox') ? $(editor.target).textbox('textbox') : $(editor.target)).focus();
			                }
			                lastModuleTableinputInputEditingIndex = index;
						} else {
							$moduleTableinputInput.datagrid('selectRow', lastModuleTableinputInputEditingIndex);
						}
					}
				}
			});
		}
		
		$moduleTableinputTabs.tabs({
			onSelect: function(title, index) {
				if (title == '表数据') {
					reloadModuleTableinputInputData();
				}
			}
		});
		$moduleTableinputDefine.datagrid({
			onClickCell: function(index, field) {
				if (index != lastModuleTableinputDefineEditingIndex) {
					if (endModuleTableinputDefineEditing()) {
						$moduleTableinputDefine.datagrid('selectRow', index).datagrid('beginEdit', index);
						var editor = $moduleTableinputDefine.datagrid('getEditor', {index: index, field: field});
		                if (editor){
		                    ($(editor.target).data('textbox') ? $(editor.target).textbox('textbox') : $(editor.target)).focus();
		                }
		                lastModuleTableinputDefineEditingIndex = index;
					} else {
						$moduleTableinputDefine.datagrid('selectRow', lastModuleTableinputDefineEditingIndex);
					}
				}
			}
		});
		$('#module-tableinput-define-add').click(function() {
			$moduleTableinputDefine.datagrid('appendRow',{type: 'string'});
		});
		$('#module-tableinput-input-add').click(function() {
			$moduleTableinputInput.datagrid('appendRow',{});
		});
		$('#module-tableinput-save').click(function() {
			reloadModuleTableinputInputData();
			var inputs = $moduleTableinputInput.datagrid('getRows');
		});
	});
</script>
</body>
</html>